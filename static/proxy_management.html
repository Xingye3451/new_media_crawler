<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代理管理 - MediaCrawler</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 1.1em;
        }

        .main-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .toolbar {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .table-container {
            overflow-x: auto;
        }

        .proxy-table {
            width: 100%;
            border-collapse: collapse;
        }

        .proxy-table th,
        .proxy-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .proxy-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #555;
        }

        .proxy-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-failed {
            background: #fff3cd;
            color: #856404;
        }

        .status-rotating {
            background: #d1ecf1;
            color: #0c5460;
        }

        .provider-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            background: #e9ecef;
            color: #495057;
        }

        .platform-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .platform-dy { background: #ff6b6b; color: white; }
        .platform-xhs { background: #4ecdc4; color: white; }
        .platform-ks { background: #45b7d1; color: white; }
        .platform-bili { background: #96ceb4; color: white; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        /* 代理IP信息样式 */
        .proxy-ip-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .proxy-ip-main {
            font-weight: bold;
            color: #333;
        }

        .proxy-ip-exit {
            font-size: 0.8em;
            color: #666;
            background: #f8f9fa;
            padding: 1px 4px;
            border-radius: 3px;
        }

        /* 账号信息样式 */
        .account-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .account-id {
            font-weight: bold;
            color: #333;
        }

        .task-id {
            font-size: 0.8em;
            color: #007bff;
            background: #e3f2fd;
            padding: 1px 4px;
            border-radius: 3px;
        }

        /* 速度信息样式 */
        .speed-info {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .speed-value {
            font-weight: bold;
            color: #28a745;
        }

        .speed-unknown {
            font-size: 0.8em;
            color: #6c757d;
            font-style: italic;
        }

        /* 成功率信息样式 */
        .success-rate-info {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .success-rate-value {
            font-weight: bold;
            color: #007bff;
        }

        .success-rate-unknown {
            font-size: 0.8em;
            color: #6c757d;
            font-style: italic;
        }

        /* 使用次数信息样式 */
        .usage-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .usage-count {
            font-weight: bold;
            color: #333;
        }

        .usage-details {
            display: flex;
            gap: 8px;
            font-size: 0.8em;
        }

        .success-count {
            color: #28a745;
        }

        .fail-count {
            color: #dc3545;
        }

        /* 描述信息样式 */
        .description-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-width: 200px;
        }

        .description-main {
            font-size: 0.9em;
            color: #333;
            word-break: break-word;
        }

        .last-used {
            font-size: 0.8em;
            color: #666;
            font-style: italic;
        }

        /* 表格行悬停效果增强 */
        .proxy-table tr:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        /* 状态徽章增强 */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        /* 提供商徽章增强 */
        .provider-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            background: #e9ecef;
            color: #495057;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        /* 实时监控样式 */
        .realtime-monitor {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .monitor-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .monitor-header h3 {
            margin: 0;
            font-size: 1.3em;
        }

        .monitor-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .refresh-status {
            font-size: 0.9em;
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(255,255,255,0.2);
        }

        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0;
        }

        .monitor-card {
            padding: 20px;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .monitor-card:last-child {
            border-right: none;
        }

        .monitor-card h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.1em;
        }

        .monitor-content {
            font-size: 0.9em;
            line-height: 1.5;
        }

        .monitor-content p {
            margin: 5px 0;
        }

        .monitor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .monitor-item:last-child {
            border-bottom: none;
        }

        .monitor-label {
            color: #666;
        }

        .monitor-value {
            font-weight: bold;
            color: #333;
        }

        .monitor-value.success {
            color: #28a745;
        }

        .monitor-value.warning {
            color: #ffc107;
        }

        .monitor-value.danger {
            color: #dc3545;
        }

        .monitor-value.info {
            color: #17a2b8;
        }

        /* 通道状态样式 */
        .channel-status {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .channel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .channel-label {
            font-size: 0.9em;
            color: #666;
        }

        .channel-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .channel-value.total {
            color: #17a2b8;
        }

        .channel-value.idle {
            color: #28a745;
        }

        .channel-value.busy {
            color: #dc3545;
        }

        .channel-value.in-use {
            color: #ffc107;
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filters {
                justify-content: center;
            }
            
            .proxy-table {
                font-size: 0.8em;
            }
            
            .proxy-table th,
            .proxy-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔗 代理管理</h1>
            <p>管理代理池、监控代理状态、优化代理使用</p>
        </div>

        <!-- 统计概览 -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3 id="totalProxies">-</h3>
                <p>总代理数</p>
            </div>
            <div class="stat-card">
                <h3 id="activeProxies">-</h3>
                <p>活跃代理</p>
            </div>
            <div class="stat-card">
                <h3 id="avgSuccessRate">-</h3>
                <p>平均成功率</p>
            </div>
            <div class="stat-card">
                <h3 id="totalUsage">-</h3>
                <p>总使用次数</p>
            </div>
            <div class="stat-card">
                <h3 id="totalAccounts">-</h3>
                <p>代理账号数</p>
            </div>
            <div class="stat-card">
                <h3 id="activeAccounts">-</h3>
                <p>活跃账号</p>
            </div>
        </div>

        <!-- 实时状态监控 -->
        <div class="realtime-monitor">
            <div class="monitor-header">
                <h3>📊 实时状态监控</h3>
                <div class="monitor-controls">
                    <button class="btn btn-info btn-sm" onclick="startAutoRefresh()">开始自动刷新</button>
                    <button class="btn btn-warning btn-sm" onclick="stopAutoRefresh()">停止自动刷新</button>
                    <span class="refresh-status" id="refreshStatus">已停止</span>
                </div>
            </div>
            <div class="monitor-grid" id="monitorGrid">
                <div class="monitor-card">
                    <h4>🔄 通道状态</h4>
                    <div class="monitor-content" id="channelStatus">
                        <p>加载中...</p>
                    </div>
                </div>
                <div class="monitor-card">
                    <h4>⚡ 代理性能</h4>
                    <div class="monitor-content" id="proxyPerformance">
                        <p>加载中...</p>
                    </div>
                </div>
                <div class="monitor-card">
                    <h4>🌍 地区分布</h4>
                    <div class="monitor-content" id="regionDistribution">
                        <p>加载中...</p>
                    </div>
                </div>
                <div class="monitor-card">
                    <h4>⏰ 过期预警</h4>
                    <div class="monitor-content" id="expiryWarning">
                        <p>加载中...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要内容 -->
        <div class="main-content">
            <!-- 工具栏 -->
            <div class="toolbar">
                <div class="filters">
                    <div class="filter-group">
                        <label>提供商</label>
                        <select id="providerFilter">
                            <option value="">全部提供商</option>
                            <option value="qingguo">青果代理</option>
                            <option value="kuaidaili">快代理</option>
                            <option value="jisuhttp">极速HTTP</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>状态</label>
                        <select id="statusFilter">
                            <option value="">全部状态</option>
                            <option value="active">活跃</option>
                            <option value="expired">已过期</option>
                            <option value="failed">失败</option>
                            <option value="rotating">轮换中</option>
                            <option value="disabled">已禁用</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>启用状态</label>
                        <select id="enabledFilter">
                            <option value="">全部</option>
                            <option value="1">启用</option>
                            <option value="0">禁用</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>区域</label>
                        <input type="text" id="areaFilter" placeholder="输入区域">
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-primary" onclick="loadProxies()">刷新</button>
                    <button class="btn btn-success" onclick="showCreateModal()">添加代理</button>
                    <button class="btn btn-warning" onclick="cleanupExpired()">清理过期</button>
                    <button class="btn btn-info" onclick="loadStats()">更新统计</button>
                    <button class="btn btn-info" onclick="batchTestProxies()">批量测试</button>
                    <button class="btn btn-info" onclick="showQingguoPanel()">青果代理</button>
                    <button class="btn btn-info" onclick="showAccountPanel()">代理账号</button>
                </div>
            </div>

            <!-- 代理列表 -->
            <div class="table-container">
                <table class="proxy-table" id="proxyTable">
                    <thead>
                        <tr>
                            <th>IP地址</th>
                            <th>端口</th>
                            <th>类型</th>
                            <th>提供商</th>
                            <th>账号</th>
                            <th>状态</th>
                            <th>启用</th>
                            <th>速度</th>
                            <th>成功率</th>
                            <th>使用次数</th>
                            <th>有效时间</th>
                            <th>区域</th>
                            <th>描述</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="proxyTableBody">
                        <tr>
                            <td colspan="13" class="loading">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 青果代理管理面板 -->
    <div id="qingguoPanel" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>🔗 青果代理管理</h2>
                <span class="close" onclick="closeQingguoPanel()">&times;</span>
            </div>
            <div class="qingguo-content">
                <!-- 账户信息 -->
                <div class="qingguo-section">
                    <h3>📊 账户信息</h3>
                    <div class="qingguo-grid">
                        <div class="qingguo-card">
                            <h4>通道状态</h4>
                            <p id="qingguoChannels">加载中...</p>
                        </div>
                        <div class="qingguo-card">
                            <h4>资源地区</h4>
                            <p id="qingguoResources">加载中...</p>
                        </div>
                        <div class="qingguo-card">
                            <h4>可用代理</h4>
                            <p id="qingguoAvailableProxies">加载中...</p>
                        </div>
                    </div>
                </div>

                <!-- 代理操作 -->
                <div class="qingguo-section">
                    <h3>🚀 代理操作</h3>
                    <div class="qingguo-grid">
                        <div class="qingguo-card">
                            <h4>提取代理</h4>
                            <div class="qingguo-form">
                                <select id="extractAccountId">
                                    <option value="">选择代理账号</option>
                                </select>
                                <select id="extractRegion">
                                    <option value="">自动选择</option>
                                    <option value="北京">北京</option>
                                    <option value="上海">上海</option>
                                    <option value="广州">广州</option>
                                    <option value="深圳">深圳</option>
                                    <option value="杭州">杭州</option>
                                </select>
                                <select id="extractIsp">
                                    <option value="">自动选择</option>
                                    <option value="电信">电信</option>
                                    <option value="联通">联通</option>
                                    <option value="移动">移动</option>
                                </select>
                                <input type="text" id="extractDescription" placeholder="描述信息 (可选)">
                                <button onclick="extractQingguoProxy()">提取</button>
                            </div>
                        </div>
                        <div class="qingguo-card">
                            <h4>批量提取</h4>
                            <div class="qingguo-form">
                                <select id="batchExtractAccountId">
                                    <option value="">选择代理账号</option>
                                </select>
                                <select id="batchExtractRegion">
                                    <option value="">自动选择</option>
                                    <option value="北京">北京</option>
                                    <option value="上海">上海</option>
                                    <option value="广州">广州</option>
                                    <option value="深圳">深圳</option>
                                    <option value="杭州">杭州</option>
                                </select>
                                <select id="batchExtractIsp">
                                    <option value="">自动选择</option>
                                    <option value="电信">电信</option>
                                    <option value="联通">联通</option>
                                    <option value="移动">移动</option>
                                </select>
                                <input type="number" id="batchExtractCount" value="5" min="1" max="10">
                                <button onclick="batchExtractQingguoProxies()">批量提取</button>
                            </div>
                        </div>
                        <div class="qingguo-card">
                            <h4>查询在用</h4>
                            <div class="qingguo-form">
                                <button onclick="getQingguoInUseProxies()">查询在用代理</button>
                                <button onclick="syncQingguoProxiesFromQuery()">同步代理信息</button>
                            </div>
                        </div>
                        <div class="qingguo-card">
                            <h4>健康检查</h4>
                            <div class="qingguo-form">
                                <button onclick="healthCheckQingguoProxies()">开始检查</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 白名单管理 -->
                <div class="qingguo-section">
                    <h3>📋 白名单管理</h3>
                    <div class="qingguo-grid">
                        <div class="qingguo-card">
                            <h4>添加白名单</h4>
                            <div class="qingguo-form">
                                <input type="text" id="addWhitelistIp" placeholder="IP地址">
                                <button onclick="addQingguoWhitelist()">添加</button>
                            </div>
                        </div>
                        <div class="qingguo-card">
                            <h4>删除白名单</h4>
                            <div class="qingguo-form">
                                <input type="text" id="removeWhitelistIp" placeholder="IP地址">
                                <button onclick="removeQingguoWhitelist()">删除</button>
                            </div>
                        </div>
                        <div class="qingguo-card">
                            <h4>查看白名单</h4>
                            <div class="qingguo-form">
                                <button onclick="getQingguoWhitelist()">查看</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 结果显示 -->
                <div class="qingguo-section">
                    <h3>📊 操作结果</h3>
                    <div id="qingguoResults" class="qingguo-results">
                        <p>操作结果将显示在这里...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .qingguo-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .qingguo-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .qingguo-section h3 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .qingguo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .qingguo-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .qingguo-card h4 {
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .qingguo-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .qingguo-form input,
        .qingguo-form select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .qingguo-form button {
            padding: 8px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .qingguo-form button:hover {
            background: #5a6fd8;
        }
        
        .qingguo-results {
            background: white;
            padding: 15px;
            border-radius: 8px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
    </style>

    <!-- 代理账号管理面板 -->
    <div id="accountPanel" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>🔑 代理账号管理</h2>
                <span class="close" onclick="closeAccountPanel()">&times;</span>
            </div>
            <div class="account-content">
                <!-- 账号统计 -->
                <div class="account-section">
                    <h3>📊 账号统计</h3>
                    <div class="account-grid">
                        <div class="account-card">
                            <h4>总账号数</h4>
                            <p id="accountTotalCount">加载中...</p>
                        </div>
                        <div class="account-card">
                            <h4>活跃账号</h4>
                            <p id="accountActiveCount">加载中...</p>
                        </div>
                        <div class="account-card">
                            <h4>平均成功率</h4>
                            <p id="accountSuccessRate">加载中...</p>
                        </div>
                        <div class="account-card">
                            <h4>总使用次数</h4>
                            <p id="accountTotalUsage">加载中...</p>
                        </div>
                    </div>
                </div>

                <!-- 账号操作 -->
                <div class="account-section">
                    <h3>🚀 账号操作</h3>
                    <div class="account-grid">
                        <div class="account-card">
                            <h4>添加账号</h4>
                            <div class="account-form">
                                <input type="text" id="accountId" placeholder="账号ID">
                                <select id="accountProvider">
                                    <option value="qingguo">青果代理</option>
                                    <option value="kuaidaili">快代理</option>
                                    <option value="jisuhttp">极速HTTP</option>
                                </select>
                                <input type="text" id="accountProviderName" placeholder="提供商名称">
                                <input type="text" id="accountApiKey" placeholder="API密钥">
                                <input type="text" id="accountApiSecret" placeholder="API密钥（可选）">
                                <input type="text" id="accountUsername" placeholder="用户名（可选）">
                                <input type="password" id="accountPassword" placeholder="密码（可选）">
                                <input type="text" id="accountSignature" placeholder="签名（可选）">
                                <input type="text" id="accountEndpointUrl" placeholder="API端点URL（可选）">
                                <input type="number" id="accountMaxPoolSize" value="10" placeholder="最大代理池大小">
                                <textarea id="accountDescription" placeholder="账号描述（可选）"></textarea>
                                <div class="account-checkbox">
                                    <input type="checkbox" id="accountIsActive" checked>
                                    <label for="accountIsActive">启用账号</label>
                                </div>
                                <div class="account-checkbox">
                                    <input type="checkbox" id="accountIsDefault">
                                    <label for="accountIsDefault">设为默认</label>
                                </div>
                                <div class="account-checkbox">
                                    <input type="checkbox" id="accountValidateIp" checked>
                                    <label for="accountValidateIp">验证IP</label>
                                </div>
                                <button onclick="createProxyAccount()">添加账号</button>
                                <button onclick="resetAccountForm()" style="background: #6c757d; margin-left: 10px;">取消编辑</button>
                            </div>
                        </div>
                        <div class="account-card">
                            <h4>账号列表</h4>
                            <div class="account-list" id="accountList">
                                <p>加载中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 账号测试 -->
                <div class="account-section">
                    <h3>🧪 账号测试</h3>
                    <div class="account-grid">
                        <div class="account-card">
                            <h4>测试账号</h4>
                            <div class="account-form">
                                <select id="testAccountId">
                                    <option value="">选择要测试的账号</option>
                                </select>
                                <button onclick="testProxyAccount()">测试连接</button>
                            </div>
                        </div>
                        <div class="account-card">
                            <h4>查看日志</h4>
                            <div class="account-form">
                                <select id="logAccountId">
                                    <option value="">选择要查看的账号</option>
                                </select>
                                <button onclick="viewAccountLogs()">查看日志</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 结果显示 -->
                <div class="account-section">
                    <h3>📊 操作结果</h3>
                    <div id="accountResults" class="account-results">
                        <p>操作结果将显示在这里...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .account-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .account-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .account-section h3 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .account-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px;
        }
        
        .account-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .account-card h4 {
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .account-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .account-form input,
        .account-form select,
        .account-form textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .account-form textarea {
            height: 60px;
            resize: vertical;
        }
        
        .account-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .account-checkbox input[type="checkbox"] {
            width: auto;
        }
        
        .account-form button {
            padding: 8px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .account-form button:hover {
            background: #5a6fd8;
        }
        
        .account-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .account-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 8px;
            background: #f8f9fa;
        }
        
        .account-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .account-item-title {
            font-weight: bold;
            color: #333;
        }
        
        .account-item-status {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .account-item-details {
            font-size: 0.9em;
            color: #666;
        }
        
        .account-item-actions {
            margin-top: 8px;
            display: flex;
            gap: 5px;
        }
        
        .account-results {
            background: white;
            padding: 15px;
            border-radius: 8px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>

    <script>
        // 自动刷新相关变量
        let autoRefreshInterval = null;
        let refreshInterval = 30000; // 30秒
        let channelStatusInterval = null; // 通道状态更新间隔

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadProxies();
            loadRealtimeMonitor();
            
            // 绑定筛选器事件
            document.getElementById('providerFilter').addEventListener('change', loadProxies);
            document.getElementById('statusFilter').addEventListener('change', loadProxies);
            document.getElementById('enabledFilter').addEventListener('change', loadProxies);
            document.getElementById('areaFilter').addEventListener('input', debounce(loadProxies, 500));
            
            // 绑定批量提取数量变化事件
            document.addEventListener('input', function(e) {
                if (e.target.id === 'batchExtractCount') {
                    // 延迟更新按钮状态，避免频繁请求
                    clearTimeout(window.batchExtractTimeout);
                    window.batchExtractTimeout = setTimeout(() => {
                        updateBatchExtractButtonStateFromCurrent();
                    }, 500);
                }
            });
        });

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 加载代理统计
        async function loadStats() {
            try {
                const response = await fetch('/api/v1/proxies/stats/overview');
                const stats = await response.json();
                
                document.getElementById('totalProxies').textContent = stats.total_proxies;
                document.getElementById('activeProxies').textContent = stats.active_proxies;
                document.getElementById('avgSuccessRate').textContent = stats.avg_success_rate + '%';
                document.getElementById('totalUsage').textContent = stats.total_usage_count;
                
                // 加载代理账号统计
                const accountResponse = await fetch('/api/v1/proxy-accounts/stats/overview');
                const accountStats = await accountResponse.json();
                
                document.getElementById('totalAccounts').textContent = accountStats.total_accounts;
                document.getElementById('activeAccounts').textContent = accountStats.active_accounts;
                
            } catch (error) {
                console.error('加载统计失败:', error);
                showError('加载统计信息失败');
            }
        }

        // 加载代理列表
        async function loadProxies() {
            try {
                            // 获取筛选条件
            const filters = {
                provider: document.getElementById('providerFilter').value,
                status: document.getElementById('statusFilter').value,
                enabled: document.getElementById('enabledFilter').value,
                area: document.getElementById('areaFilter').value,
                page: 1,
                page_size: 20
            };
                
                // 构建查询参数
                const params = new URLSearchParams();
                Object.entries(filters).forEach(([key, value]) => {
                    if (value !== null && value !== '') {
                        params.append(key, value);
                    }
                });
                
                const response = await fetch(`/api/v1/proxies/?${params.toString()}`);
                const proxies = await response.json();
                
                renderProxyTable(proxies);
                
            } catch (error) {
                console.error('加载代理列表失败:', error);
                showError('加载代理列表失败');
                document.getElementById('proxyTableBody').innerHTML = 
                    '<tr><td colspan="13" class="error">加载失败</td></tr>';
            }
        }

        // 渲染代理表格
        function renderProxyTable(proxies) {
            const tbody = document.getElementById('proxyTableBody');
            
            if (!proxies || proxies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="loading">暂无数据</td></tr>';
                return;
            }
            
            tbody.innerHTML = proxies.map(proxy => `
                <tr>
                    <td>
                        <div class="proxy-ip-info">
                            <div class="proxy-ip-main">${proxy.ip}</div>
                            ${proxy.proxy_ip ? `<div class="proxy-ip-exit">出口: ${proxy.proxy_ip}</div>` : ''}
                        </div>
                    </td>
                    <td>${proxy.port}</td>
                    <td>${proxy.proxy_type.toUpperCase()}</td>
                    <td><span class="provider-badge">${getProviderName(proxy.provider)}</span></td>
                    <td>
                        <div class="account-info">
                            <div class="account-id">${proxy.account_id || '-'}</div>
                            ${proxy.task_id ? `<div class="task-id">Task: ${proxy.task_id}</div>` : ''}
                        </div>
                    </td>
                    <td><span class="status-badge status-${proxy.status}">${getStatusName(proxy.status)}</span></td>
                    <td>
                        <span class="status-badge ${proxy.enabled ? 'status-active' : 'status-expired'}">
                            ${proxy.enabled ? '启用' : '禁用'}
                        </span>
                    </td>
                    <td>
                        <div class="speed-info">
                            ${proxy.speed ? `<span class="speed-value">${proxy.speed}ms</span>` : '<span class="speed-unknown">未测试</span>'}
                        </div>
                    </td>
                    <td>
                        <div class="success-rate-info">
                            ${proxy.success_rate ? `<span class="success-rate-value">${proxy.success_rate}%</span>` : '<span class="success-rate-unknown">未统计</span>'}
                        </div>
                    </td>
                    <td>
                        <div class="usage-info">
                            <div class="usage-count">${proxy.usage_count}</div>
                            <div class="usage-details">
                                <span class="success-count">✓${proxy.success_count || 0}</span>
                                <span class="fail-count">✗${proxy.fail_count || 0}</span>
                            </div>
                        </div>
                    </td>
                    <td>${formatExpireTime(proxy.expire_ts)}</td>
                    <td>${proxy.area || '-'}</td>
                    <td>
                        <div class="description-info">
                            <div class="description-main">${proxy.description || '-'}</div>
                            ${proxy.last_used_at ? `<div class="last-used">最后使用: ${formatDate(proxy.last_used_at)}</div>` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-info btn-sm" onclick="testProxy('${proxy.proxy_id}')" title="测试代理速度">测试</button>
                            <button class="btn btn-success btn-sm" onclick="toggleProxy('${proxy.proxy_id}', ${proxy.enabled})" title="${proxy.enabled ? '禁用' : '启用'}代理">
                                ${proxy.enabled ? '禁用' : '启用'}
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editProxy('${proxy.proxy_id}')" title="编辑代理信息">编辑</button>
                            ${proxy.provider === 'qingguo' ? `<button class="btn btn-info btn-sm" onclick="syncProxy('${proxy.proxy_id}')" title="同步代理信息">同步</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // 获取平台名称
        function getPlatformName(platform) {
            const names = {
                'dy': '抖音',
                'xhs': '小红书',
                'ks': '快手',
                'bili': 'B站'
            };
            return names[platform] || platform;
        }

        // 获取提供商名称
        function getProviderName(provider) {
            const names = {
                'qingguo': '青果代理',
                'kuaidaili': '快代理',
                'jisuhttp': '极速HTTP'
            };
            return names[provider] || provider;
        }

        // 获取状态名称
        function getStatusName(status) {
            const names = {
                'active': '活跃',
                'expired': '已过期',
                'failed': '失败',
                'rotating': '轮换中'
            };
            return names[status] || status;
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        // 格式化有效时间
        function formatExpireTime(expireTs) {
            if (!expireTs) return '-';
            
            const now = Math.floor(Date.now() / 1000);
            const expireTime = parseInt(expireTs);
            
            if (expireTime <= now) {
                return '<span class="status-badge status-expired">已过期</span>';
            }
            
            const remainingSeconds = expireTime - now;
            const remainingHours = Math.floor(remainingSeconds / 3600);
            const remainingMinutes = Math.floor((remainingSeconds % 3600) / 60);
            
            if (remainingHours > 24) {
                const remainingDays = Math.floor(remainingHours / 24);
                return `<span class="status-badge status-active">${remainingDays}天</span>`;
            } else if (remainingHours > 0) {
                return `<span class="status-badge status-active">${remainingHours}小时</span>`;
            } else {
                return `<span class="status-badge status-active">${remainingMinutes}分钟</span>`;
            }
        }

        // 测试代理
        async function testProxy(proxyId) {
            // 找到对应的按钮并显示加载状态
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '测试中...';
            button.disabled = true;
            button.style.background = '#6c757d';
            
            try {
                const response = await fetch(`/api/v1/proxies/${proxyId}/test`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    // 更新按钮显示测试结果
                    button.textContent = `${result.speed}ms`;
                    button.style.background = '#28a745';
                    button.title = `测试成功 - 速度: ${result.speed}ms`;
                    
                    // 3秒后恢复原状
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '';
                        button.disabled = false;
                        button.title = '测试代理速度';
                    }, 3000);
                    
                    showSuccess(`代理测试成功，速度: ${result.speed}ms`);
                } else {
                    // 显示失败状态
                    button.textContent = '失败';
                    button.style.background = '#dc3545';
                    button.title = `测试失败: ${result.error}`;
                    
                    // 3秒后恢复原状
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '';
                        button.disabled = false;
                        button.title = '测试代理速度';
                    }, 3000);
                    
                    showError(`代理测试失败: ${result.error}`);
                }
                
                loadProxies(); // 刷新列表以更新状态
                
            } catch (error) {
                console.error('测试代理失败:', error);
                
                // 显示错误状态
                button.textContent = '错误';
                button.style.background = '#dc3545';
                button.title = '测试失败';
                
                // 3秒后恢复原状
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                    button.disabled = false;
                    button.title = '测试代理速度';
                }, 3000);
                
                showError('测试代理失败');
            }
        }

        // 切换代理启用/禁用状态
        async function toggleProxy(proxyId, currentEnabled) {
            try {
                const action = currentEnabled ? 'disable' : 'enable';
                const response = await fetch(`/api/v1/proxies/${proxyId}/${action}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showSuccess(`代理${currentEnabled ? '禁用' : '启用'}成功`);
                    loadProxies();
                    loadStats();
                } else {
                    const error = await response.json();
                    showError(error.detail || `${currentEnabled ? '禁用' : '启用'}失败`);
                }
                
            } catch (error) {
                console.error(`${currentEnabled ? '禁用' : '启用'}代理失败:`, error);
                showError(`${currentEnabled ? '禁用' : '启用'}代理失败`);
            }
        }

        // 编辑代理
        function editProxy(proxyId) {
            showError('编辑功能开发中...');
        }

        // 释放代理功能已移除 - 动态型代理不支持释放IP
        // 请使用启用/禁用功能来管理代理状态

        // 同步代理信息
        async function syncProxy(proxyId) {
            try {
                // 显示同步中状态
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '同步中...';
                button.disabled = true;
                button.style.background = '#6c757d';
                
                const response = await fetch(`/api/v1/proxies/${proxyId}/sync`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    // 显示成功状态
                    button.textContent = '成功';
                    button.style.background = '#28a745';
                    button.title = result.message;
                    
                    showSuccess(result.message);
                    
                    // 3秒后恢复原状
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '';
                        button.disabled = false;
                        button.title = '同步代理信息';
                    }, 3000);
                    
                    // 刷新代理列表
                    loadProxies();
                    loadStats();
                    loadRealtimeMonitor();
                } else {
                    // 显示失败状态
                    button.textContent = '失败';
                    button.style.background = '#dc3545';
                    button.title = result.message;
                    
                    showError(result.message);
                    
                    // 3秒后恢复原状
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '';
                        button.disabled = false;
                        button.title = '同步代理信息';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('同步代理失败:', error);
                
                // 显示错误状态
                const button = event.target;
                button.textContent = '错误';
                button.style.background = '#dc3545';
                button.title = '同步失败';
                
                // 3秒后恢复原状
                setTimeout(() => {
                    button.textContent = '同步';
                    button.style.background = '';
                    button.disabled = false;
                    button.title = '同步代理信息';
                }, 3000);
                
                showError('同步代理失败: ' + error.message);
            }
        }

        // 清理过期代理
        async function cleanupExpired() {
            if (!confirm('确定要清理所有过期的代理吗？')) return;
            
            try {
                const response = await fetch('/api/v1/proxies/cleanup/expired', {
                    method: 'POST'
                });
                const result = await response.json();
                
                showSuccess(`清理完成，共清理 ${result.affected_rows} 个过期代理`);
                loadProxies();
                loadStats();
                
            } catch (error) {
                console.error('清理过期代理失败:', error);
                showError('清理过期代理失败');
            }
        }

        // 显示创建模态框
        function showCreateModal() {
            showError('添加代理功能开发中...');
        }

        // 显示成功消息
        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = message;
            document.querySelector('.container').insertBefore(div, document.querySelector('.stats-grid'));
            
            setTimeout(() => div.remove(), 3000);
        }

        // 显示错误消息
        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = message;
            document.querySelector('.container').insertBefore(div, document.querySelector('.stats-grid'));
            
            setTimeout(() => div.remove(), 5000);
        }

        // ==================== 青果代理管理功能 ====================

        // 显示青果代理面板
        function showQingguoPanel() {
            document.getElementById('qingguoPanel').style.display = 'block';
            loadQingguoAccountInfo();
            loadQingguoAccountOptions();
            
            // 开始实时更新通道状态
            startChannelStatusUpdate();
        }

        // 关闭青果代理面板
        function closeQingguoPanel() {
            document.getElementById('qingguoPanel').style.display = 'none';
            
            // 停止实时更新通道状态
            stopChannelStatusUpdate();
        }

        // 加载青果代理账号选项
        async function loadQingguoAccountOptions() {
            try {
                const response = await fetch('/api/v1/proxy-accounts/');
                const accounts = await response.json();
                
                const extractSelect = document.getElementById('extractAccountId');
                const batchSelect = document.getElementById('batchExtractAccountId');
                
                // 清空选择框
                extractSelect.innerHTML = '<option value="">选择代理账号</option>';
                batchSelect.innerHTML = '<option value="">选择代理账号</option>';
                
                // 只显示青果代理账号
                const qingguoAccounts = accounts.filter(account => account.provider === 'qingguo' && account.is_active);
                
                qingguoAccounts.forEach(account => {
                    const extractOption = document.createElement('option');
                    extractOption.value = account.account_id;
                    extractOption.textContent = `${account.account_id} (${account.provider_name})`;
                    extractSelect.appendChild(extractOption);
                    
                    const batchOption = document.createElement('option');
                    batchOption.value = account.account_id;
                    batchOption.textContent = `${account.account_id} (${account.provider_name})`;
                    batchSelect.appendChild(batchOption);
                });
                
            } catch (error) {
                console.error('加载代理账号选项失败:', error);
                showQingguoResult('加载代理账号选项失败: ' + error.message);
            }
        }

        // 加载青果账户信息
        async function loadQingguoAccountInfo() {
            try {
                // 加载通道状态
                const channelsResponse = await fetch('/api/v1/qingguo/channels');
                if (channelsResponse.ok) {
                    const channelsData = await channelsResponse.json();
                    if (channelsData.success) {
                        const channels = channelsData.channels;
                        document.getElementById('qingguoChannels').textContent = 
                            `总数: ${channels.total}, 空闲: ${channels.idle}, 使用中: ${channels.in_use}`;
                    } else {
                        document.getElementById('qingguoChannels').textContent = '获取失败';
                    }
                }

                // 加载资源地区
                const resourcesResponse = await fetch('/api/v1/qingguo/resources');
                if (resourcesResponse.ok) {
                    const resourcesData = await resourcesResponse.json();
                    if (resourcesData.success) {
                        const resources = resourcesData.resources;
                        const regionCount = new Set(resources.map(r => r.area)).size;
                        document.getElementById('qingguoResources').textContent = 
                            `${regionCount} 个地区可用`;
                    } else {
                        document.getElementById('qingguoResources').textContent = '获取失败';
                    }
                }

                // 加载可用代理数量
                const proxiesResponse = await fetch('/api/v1/qingguo/available-count');
                if (proxiesResponse.ok) {
                    const proxiesData = await proxiesResponse.json();
                    if (proxiesData.success) {
                        document.getElementById('qingguoAvailableProxies').textContent = 
                            `${proxiesData.count} 个可用`;
                    } else {
                        document.getElementById('qingguoAvailableProxies').textContent = '获取失败';
                    }
                }

            } catch (error) {
                console.error('加载青果账户信息失败:', error);
                showQingguoResult('加载账户信息失败: ' + error.message);
            }
        }

        // 提取青果代理
        async function extractQingguoProxy() {
            const accountId = document.getElementById('extractAccountId').value;
            const region = document.getElementById('extractRegion').value;
            const isp = document.getElementById('extractIsp').value;
            const description = document.getElementById('extractDescription').value;

            if (!accountId) {
                showQingguoResult('请选择代理账号');
                return;
            }

            // 先检查通道状态
            try {
                const channelsResponse = await fetch('/api/v1/qingguo/channels');
                const channelsResult = await channelsResponse.json();
                
                if (!channelsResult.success) {
                    showQingguoResult('❌ 无法获取通道状态，请检查网络连接');
                    return;
                }
                
                const channels = channelsResult.channels;
                const idleCount = channels.idle || 0;
                
                // 前端检查：是否有空闲通道
                if (idleCount < 1) {
                    showQingguoResult(`❌ 没有空闲通道！\n\n当前状态:\n- 总通道数: ${channels.total}\n- 空闲通道: ${channels.idle}\n- 使用中: ${channels.in_use}\n\n需要先释放一些代理或等待通道空闲`);
                    return;
                }
                
                // 显示确认信息
                const confirmMessage = `确认提取代理？\n\n当前状态:\n- 总通道数: ${channels.total}\n- 空闲通道: ${channels.idle}\n- 使用中: ${channels.in_use}`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
            } catch (error) {
                console.error('检查通道状态失败:', error);
                showQingguoResult('❌ 检查通道状态失败，请重试');
                return;
            }

            // 开始提取代理
            try {
                const params = new URLSearchParams();
                params.append('account_id', accountId);
                params.append('region', region);
                params.append('isp', isp);
                if (description) params.append('description', description);

                showQingguoResult('🔄 正在提取代理，请稍候...');

                const response = await fetch(`/api/v1/qingguo/extract?${params.toString()}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showQingguoResult(`✅ 代理提取成功！\n\n账号: ${accountId}\nIP: ${result.proxy.ip}\n端口: ${result.proxy.port}\n区域: ${result.proxy.area}\n描述: ${result.proxy.description}`);
                    loadProxies(); // 刷新代理列表
                    loadQingguoAccountInfo(); // 刷新账户信息
                } else {
                    showQingguoResult(`❌ 代理提取失败: ${result.detail}`);
                }

            } catch (error) {
                console.error('提取青果代理失败:', error);
                showQingguoResult('❌ 提取代理失败: ' + error.message);
            }
        }

        // 批量提取青果代理
        async function batchExtractQingguoProxies() {
            const accountId = document.getElementById('batchExtractAccountId').value;
            const region = document.getElementById('batchExtractRegion').value;
            const isp = document.getElementById('batchExtractIsp').value;
            const count = parseInt(document.getElementById('batchExtractCount').value);

            if (!accountId) {
                showQingguoResult('请选择代理账号');
                return;
            }

            // 先检查通道状态
            try {
                const channelsResponse = await fetch('/api/v1/qingguo/channels');
                const channelsResult = await channelsResponse.json();
                
                if (!channelsResult.success) {
                    showQingguoResult('❌ 无法获取通道状态，请检查网络连接');
                    return;
                }
                
                const channels = channelsResult.channels;
                const idleCount = channels.idle || 0;
                
                // 前端检查：空闲通道数是否足够
                if (idleCount < count) {
                    showQingguoResult(`❌ 通道空闲数不足！\n\n当前空闲通道: ${idleCount}\n请求提取数量: ${count}\n\n需要先释放一些代理或等待通道空闲`);
                    return;
                }
                
                // 显示确认信息
                const confirmMessage = `确认批量提取 ${count} 个代理？\n\n当前状态:\n- 总通道数: ${channels.total}\n- 空闲通道: ${channels.idle}\n- 使用中: ${channels.in_use}\n- 请求数量: ${count}`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
            } catch (error) {
                console.error('检查通道状态失败:', error);
                showQingguoResult('❌ 检查通道状态失败，请重试');
                return;
            }

            // 开始批量提取
            try {
                const params = new URLSearchParams();
                params.append('account_id', accountId);
                params.append('region', region);
                params.append('isp', isp);
                params.append('count', count);

                showQingguoResult('🔄 正在批量提取代理，请稍候...');

                const response = await fetch(`/api/v1/qingguo/batch-extract?${params.toString()}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    let message = `✅ 批量提取完成！\n\n账号: ${accountId}\n总计: ${result.total}\n成功: ${result.success_count}\n失败: ${result.fail_count}\n\n`;
                    
                    if (result.results && result.results.length > 0) {
                        result.results.forEach(item => {
                            if (item.success) {
                                message += `✅ ${item.index}. ${item.proxy.ip}:${item.proxy.port} (${item.proxy.area})\n`;
                            } else {
                                message += `❌ ${item.index}. ${item.error}\n`;
                            }
                        });
                    }

                    showQingguoResult(message);
                    loadProxies(); // 刷新代理列表
                    loadQingguoAccountInfo(); // 刷新账户信息
                } else {
                    showQingguoResult(`❌ 批量提取失败: ${result.detail}`);
                }

            } catch (error) {
                console.error('批量提取青果代理失败:', error);
                showQingguoResult('❌ 批量提取失败: ' + error.message);
            }
        }

        // 查询青果在用代理
        async function getQingguoInUseProxies() {
            try {
                const response = await fetch('/api/v1/qingguo/in-use');
                const result = await response.json();

                if (result.success) {
                    let message = `📊 在用代理查询结果\n\n总计: ${result.total}个\n\n`;
                    
                    result.proxies.forEach(proxy => {
                        message += `• ${proxy.ip}:${proxy.port} (${proxy.area || '未知区域'})\n`;
                    });

                    showQingguoResult(message);
                } else {
                    showQingguoResult(`❌ 查询失败: ${result.detail}`);
                }

            } catch (error) {
                console.error('查询青果在用代理失败:', error);
                showQingguoResult('查询失败: ' + error.message);
            }
        }

        // 青果代理健康检查
        async function healthCheckQingguoProxies() {
            try {
                const response = await fetch('/api/v1/qingguo/health-check', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    let message = `🔍 健康检查结果\n\n总计: ${result.total}个\n成功: ${result.success_count}个\n失败: ${result.fail_count}个\n成功率: ${result.success_rate}%\n\n`;
                    
                    result.results.forEach(item => {
                        if (item.success) {
                            message += `✅ ${item.ip}:${item.port} (${item.speed}ms)\n`;
                        } else {
                            message += `❌ ${item.ip}:${item.port} (${item.error})\n`;
                        }
                    });

                    showQingguoResult(message);
                } else {
                    showQingguoResult(`❌ 健康检查失败: ${result.detail}`);
                }

            } catch (error) {
                console.error('青果代理健康检查失败:', error);
                showQingguoResult('健康检查失败: ' + error.message);
            }
        }

        // 同步青果代理信息
        async function syncQingguoProxiesFromQuery() {
            try {
                const response = await fetch('/api/v1/qingguo/sync-from-query', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    let message = `✅ 同步完成\n\n${result.message}\n\n`;
                    
                    if (result.proxies && result.proxies.length > 0) {
                        message += "同步的代理列表:\n";
                        result.proxies.forEach(proxy => {
                            message += `• ${proxy.ip}:${proxy.port} (${proxy.area || '未知区域'})\n`;
                        });
                    }

                    showQingguoResult(message);
                    loadProxies(); // 刷新代理列表
                } else {
                    showQingguoResult(`❌ 同步失败: ${result.detail}`);
                }

            } catch (error) {
                console.error('同步青果代理信息失败:', error);
                showQingguoResult('同步失败: ' + error.message);
            }
        }

        // 添加青果白名单
        async function addQingguoWhitelist() {
            const ip = document.getElementById('addWhitelistIp').value;
            if (!ip) {
                showQingguoResult('请输入IP地址');
                return;
            }

            try {
                const response = await fetch(`/api/v1/qingguo/whitelist/add?ip=${ip}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showQingguoResult(`✅ ${result.message}`);
                    document.getElementById('addWhitelistIp').value = '';
                } else {
                    showQingguoResult(`❌ 添加失败: ${result.detail}`);
                }

            } catch (error) {
                console.error('添加青果白名单失败:', error);
                showQingguoResult('添加失败: ' + error.message);
            }
        }

        // 删除青果白名单
        async function removeQingguoWhitelist() {
            const ip = document.getElementById('removeWhitelistIp').value;
            if (!ip) {
                showQingguoResult('请输入IP地址');
                return;
            }

            try {
                const response = await fetch(`/api/v1/qingguo/whitelist/remove?ip=${ip}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    showQingguoResult(`✅ ${result.message}`);
                    document.getElementById('removeWhitelistIp').value = '';
                } else {
                    showQingguoResult(`❌ 删除失败: ${result.detail}`);
                }

            } catch (error) {
                console.error('删除青果白名单失败:', error);
                showQingguoResult('删除失败: ' + error.message);
            }
        }

        // 获取青果白名单
        async function getQingguoWhitelist() {
            try {
                const response = await fetch('/api/v1/qingguo/whitelist');
                const result = await response.json();

                if (result.success) {
                    let message = `📋 白名单列表\n\n`;
                    
                    if (result.whitelist && result.whitelist.length > 0) {
                        result.whitelist.forEach(ip => {
                            message += `• ${ip}\n`;
                        });
                    } else {
                        message += '暂无白名单记录';
                    }

                    showQingguoResult(message);
                } else {
                    showQingguoResult(`❌ 获取失败: ${result.detail}`);
                }

            } catch (error) {
                console.error('获取青果白名单失败:', error);
                showQingguoResult('获取失败: ' + error.message);
            }
        }

        // 显示青果操作结果
        function showQingguoResult(message) {
            document.getElementById('qingguoResults').innerHTML = `<pre>${message}</pre>`;
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const qingguoPanel = document.getElementById('qingguoPanel');
            if (event.target === qingguoPanel) {
                closeQingguoPanel();
            }
            
            const accountPanel = document.getElementById('accountPanel');
            if (event.target === accountPanel) {
                closeAccountPanel();
            }
        }

        // ==================== 代理账号管理功能 ====================

        // 显示代理账号面板
        function showAccountPanel() {
            document.getElementById('accountPanel').style.display = 'block';
            loadAccountStats();
            loadAccountList();
        }

        // 关闭代理账号面板
        function closeAccountPanel() {
            document.getElementById('accountPanel').style.display = 'none';
        }

        // 加载代理账号统计
        async function loadAccountStats() {
            try {
                const response = await fetch('/api/v1/proxy-accounts/stats/overview');
                const stats = await response.json();
                
                document.getElementById('accountTotalCount').textContent = stats.total_accounts;
                document.getElementById('accountActiveCount').textContent = stats.active_accounts;
                document.getElementById('accountSuccessRate').textContent = stats.avg_success_rate + '%';
                document.getElementById('accountTotalUsage').textContent = stats.total_usage;
                
            } catch (error) {
                console.error('加载代理账号统计失败:', error);
                showAccountResult('加载代理账号统计失败: ' + error.message);
            }
        }

        // 加载代理账号列表
        async function loadAccountList() {
            try {
                const response = await fetch('/api/v1/proxy-accounts/');
                const accounts = await response.json();
                
                const accountList = document.getElementById('accountList');
                const testSelect = document.getElementById('testAccountId');
                const logSelect = document.getElementById('logAccountId');
                
                // 清空选择框
                testSelect.innerHTML = '<option value="">选择要测试的账号</option>';
                logSelect.innerHTML = '<option value="">选择要查看的账号</option>';
                
                if (!accounts || accounts.length === 0) {
                    accountList.innerHTML = '<p>暂无代理账号</p>';
                    return;
                }
                
                accountList.innerHTML = accounts.map(account => `
                    <div class="account-item">
                        <div class="account-item-header">
                            <span class="account-item-title">${account.account_id}</span>
                            <span class="account-item-status ${account.is_active ? 'status-active' : 'status-inactive'}">
                                ${account.is_active ? '启用' : '禁用'}
                            </span>
                        </div>
                        <div class="account-item-details">
                            <div>提供商: ${account.provider_name} (${account.provider})</div>
                            <div>API密钥: ${account.api_key.substring(0, 8)}...</div>
                            <div>最大池大小: ${account.max_pool_size}</div>
                            <div>使用次数: ${account.usage_count} | 成功: ${account.success_count} | 失败: ${account.fail_count}</div>
                            <div>最后使用: ${account.last_used_at ? new Date(account.last_used_at).toLocaleString() : '从未使用'}</div>
                            ${account.description ? `<div>描述: ${account.description}</div>` : ''}
                        </div>
                        <div class="account-item-actions">
                            <button class="btn btn-info btn-sm" onclick="testAccount('${account.account_id}')">测试</button>
                            <button class="btn btn-warning btn-sm" onclick="editAccount('${account.account_id}')">编辑</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteAccount('${account.account_id}')">删除</button>
                        </div>
                    </div>
                `).join('');
                
                // 填充选择框
                accounts.forEach(account => {
                    const testOption = document.createElement('option');
                    testOption.value = account.account_id;
                    testOption.textContent = `${account.account_id} (${account.provider_name})`;
                    testSelect.appendChild(testOption);
                    
                    const logOption = document.createElement('option');
                    logOption.value = account.account_id;
                    logOption.textContent = `${account.account_id} (${account.provider_name})`;
                    logSelect.appendChild(logOption);
                });
                
            } catch (error) {
                console.error('加载代理账号列表失败:', error);
                showAccountResult('加载代理账号列表失败: ' + error.message);
            }
        }

        // 创建代理账号
        async function createProxyAccount() {
            const accountData = {
                account_id: document.getElementById('accountId').value,
                provider: document.getElementById('accountProvider').value,
                provider_name: document.getElementById('accountProviderName').value,
                api_key: document.getElementById('accountApiKey').value,
                api_secret: document.getElementById('accountApiSecret').value || null,
                username: document.getElementById('accountUsername').value || null,
                password: document.getElementById('accountPassword').value || null,
                signature: document.getElementById('accountSignature').value || null,
                endpoint_url: document.getElementById('accountEndpointUrl').value || null,
                is_active: document.getElementById('accountIsActive').checked,
                is_default: document.getElementById('accountIsDefault').checked,
                max_pool_size: parseInt(document.getElementById('accountMaxPoolSize').value),
                validate_ip: document.getElementById('accountValidateIp').checked,
                description: document.getElementById('accountDescription').value || null
            };

            // 验证必填字段
            if (!accountData.account_id || !accountData.provider_name || !accountData.api_key) {
                showAccountResult('请填写必填字段：账号ID、提供商名称、API密钥');
                return;
            }

            try {
                const response = await fetch('/api/v1/proxy-accounts/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(accountData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAccountResult(`✅ 代理账号创建成功！\n\n账号ID: ${result.account_id}\n提供商: ${result.provider_name}\n状态: ${result.is_active ? '启用' : '禁用'}`);
                    
                    // 清空表单
                    document.getElementById('accountId').value = '';
                    document.getElementById('accountProviderName').value = '';
                    document.getElementById('accountApiKey').value = '';
                    document.getElementById('accountApiSecret').value = '';
                    document.getElementById('accountUsername').value = '';
                    document.getElementById('accountPassword').value = '';
                    document.getElementById('accountSignature').value = '';
                    document.getElementById('accountEndpointUrl').value = '';
                    document.getElementById('accountDescription').value = '';
                    
                    // 刷新列表
                    loadAccountList();
                    loadAccountStats();
                } else {
                    showAccountResult(`❌ 创建失败: ${result.detail}`);
                }
                
            } catch (error) {
                console.error('创建代理账号失败:', error);
                showAccountResult('创建代理账号失败: ' + error.message);
            }
        }

        // 测试代理账号
        async function testProxyAccount() {
            const accountId = document.getElementById('testAccountId').value;
            if (!accountId) {
                showAccountResult('请选择要测试的账号');
                return;
            }

            try {
                const response = await fetch(`/api/v1/proxy-accounts/${accountId}/test`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    showAccountResult(`✅ 账号测试成功！\n\n响应时间: ${result.response_time}ms`);
                } else {
                    showAccountResult(`❌ 账号测试失败: ${result.error_message}`);
                }
                
                // 刷新列表
                loadAccountList();
                loadAccountStats();
                
            } catch (error) {
                console.error('测试代理账号失败:', error);
                showAccountResult('测试代理账号失败: ' + error.message);
            }
        }

        // 测试指定账号
        async function testAccount(accountId) {
            try {
                const response = await fetch(`/api/v1/proxy-accounts/${accountId}/test`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    showAccountResult(`✅ 账号 ${accountId} 测试成功！\n\n响应时间: ${result.response_time}ms`);
                } else {
                    showAccountResult(`❌ 账号 ${accountId} 测试失败: ${result.error_message}`);
                }
                
                // 刷新列表
                loadAccountList();
                loadAccountStats();
                
            } catch (error) {
                console.error('测试代理账号失败:', error);
                showAccountResult('测试代理账号失败: ' + error.message);
            }
        }

        // 编辑账号
        async function editAccount(accountId) {
            try {
                // 获取账号详情
                const response = await fetch(`/api/v1/proxy-accounts/${accountId}`);
                const account = await response.json();
                
                if (!response.ok) {
                    showAccountResult(`❌ 获取账号信息失败: ${account.detail}`);
                    return;
                }
                
                // 填充表单
                document.getElementById('accountId').value = account.account_id;
                document.getElementById('accountProvider').value = account.provider;
                document.getElementById('accountProviderName').value = account.provider_name;
                document.getElementById('accountApiKey').value = account.api_key;
                document.getElementById('accountApiSecret').value = account.api_secret || '';
                document.getElementById('accountUsername').value = account.username || '';
                document.getElementById('accountPassword').value = account.password || '';
                document.getElementById('accountSignature').value = account.signature || '';
                document.getElementById('accountEndpointUrl').value = account.endpoint_url || '';
                document.getElementById('accountMaxPoolSize').value = account.max_pool_size;
                document.getElementById('accountDescription').value = account.description || '';
                document.getElementById('accountIsActive').checked = account.is_active;
                document.getElementById('accountIsDefault').checked = account.is_default;
                document.getElementById('accountValidateIp').checked = account.validate_ip;
                
                // 修改按钮文本和功能
                const addButton = document.querySelector('.account-form button');
                addButton.textContent = '更新账号';
                addButton.onclick = () => updateProxyAccount(accountId);
                
                showAccountResult(`📝 正在编辑账号: ${accountId}\n\n请修改信息后点击"更新账号"按钮`);
                
            } catch (error) {
                console.error('获取账号信息失败:', error);
                showAccountResult('获取账号信息失败: ' + error.message);
            }
        }
        
        // 更新代理账号
        async function updateProxyAccount(accountId) {
            const accountData = {
                account_id: document.getElementById('accountId').value,
                provider: document.getElementById('accountProvider').value,
                provider_name: document.getElementById('accountProviderName').value,
                api_key: document.getElementById('accountApiKey').value,
                api_secret: document.getElementById('accountApiSecret').value || null,
                username: document.getElementById('accountUsername').value || null,
                password: document.getElementById('accountPassword').value || null,
                signature: document.getElementById('accountSignature').value || null,
                endpoint_url: document.getElementById('accountEndpointUrl').value || null,
                is_active: document.getElementById('accountIsActive').checked,
                is_default: document.getElementById('accountIsDefault').checked,
                max_pool_size: parseInt(document.getElementById('accountMaxPoolSize').value),
                validate_ip: document.getElementById('accountValidateIp').checked,
                description: document.getElementById('accountDescription').value || null
            };

            // 验证必填字段
            if (!accountData.account_id || !accountData.provider_name || !accountData.api_key) {
                showAccountResult('请填写必填字段：账号ID、提供商名称、API密钥');
                return;
            }

            try {
                const response = await fetch(`/api/v1/proxy-accounts/${accountId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(accountData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAccountResult(`✅ 代理账号更新成功！\n\n账号ID: ${result.account_id}\n提供商: ${result.provider_name}\n状态: ${result.is_active ? '启用' : '禁用'}`);
                    
                    // 重置表单和按钮
                    resetAccountForm();
                    
                    // 刷新列表
                    loadAccountList();
                    loadAccountStats();
                } else {
                    showAccountResult(`❌ 更新失败: ${result.detail}`);
                }
                
            } catch (error) {
                console.error('更新代理账号失败:', error);
                showAccountResult('更新代理账号失败: ' + error.message);
            }
        }
        
        // 重置账号表单
        function resetAccountForm() {
            document.getElementById('accountId').value = '';
            document.getElementById('accountProviderName').value = '';
            document.getElementById('accountApiKey').value = '';
            document.getElementById('accountApiSecret').value = '';
            document.getElementById('accountUsername').value = '';
            document.getElementById('accountPassword').value = '';
            document.getElementById('accountSignature').value = '';
            document.getElementById('accountEndpointUrl').value = '';
            document.getElementById('accountDescription').value = '';
            document.getElementById('accountIsActive').checked = true;
            document.getElementById('accountIsDefault').checked = false;
            document.getElementById('accountValidateIp').checked = true;
            
            // 恢复按钮文本和功能
            const addButton = document.querySelector('.account-form button');
            addButton.textContent = '添加账号';
            addButton.onclick = createProxyAccount;
        }

        // 删除账号
        async function deleteAccount(accountId) {
            if (!confirm(`确定要删除账号 ${accountId} 吗？`)) return;
            
            try {
                const response = await fetch(`/api/v1/proxy-accounts/${accountId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAccountResult(`✅ ${result.message}`);
                    loadAccountList();
                    loadAccountStats();
                } else {
                    const error = await response.json();
                    showAccountResult(`❌ 删除失败: ${error.detail}`);
                }
                
            } catch (error) {
                console.error('删除代理账号失败:', error);
                showAccountResult('删除代理账号失败: ' + error.message);
            }
        }

        // 查看账号日志
        async function viewAccountLogs() {
            const accountId = document.getElementById('logAccountId').value;
            if (!accountId) {
                showAccountResult('请选择要查看的账号');
                return;
            }

            try {
                const response = await fetch(`/api/v1/proxy-accounts/${accountId}/logs`);
                const result = await response.json();
                
                if (result.logs && result.logs.length > 0) {
                    let message = `📋 账号 ${accountId} 使用日志\n\n`;
                    result.logs.forEach(log => {
                        const time = new Date(log.created_at).toLocaleString();
                        const status = log.success ? '✅' : '❌';
                        message += `${status} ${time} - ${log.operation}\n`;
                        if (log.response_time) message += `   响应时间: ${log.response_time}ms\n`;
                        if (log.error_message) message += `   错误: ${log.error_message}\n`;
                        message += '\n';
                    });
                    showAccountResult(message);
                } else {
                    showAccountResult(`账号 ${accountId} 暂无使用日志`);
                }
                
            } catch (error) {
                console.error('查看账号日志失败:', error);
                showAccountResult('查看账号日志失败: ' + error.message);
            }
        }

        // 显示代理账号操作结果
        function showAccountResult(message) {
            document.getElementById('accountResults').innerHTML = `<pre>${message}</pre>`;
        }

        // ==================== 实时监控功能 ====================

        // 加载实时监控数据
        async function loadRealtimeMonitor() {
            try {
                await Promise.all([
                    loadChannelStatus(),
                    loadProxyPerformance(),
                    loadRegionDistribution(),
                    loadExpiryWarning()
                ]);
            } catch (error) {
                console.error('加载实时监控数据失败:', error);
            }
        }

        // 加载通道状态
        async function loadChannelStatus() {
            try {
                const response = await fetch('/api/v1/qingguo/channels');
                const result = await response.json();
                
                if (result.success) {
                    const channels = result.channels;
                    const content = `
                        <div class="monitor-item">
                            <span class="monitor-label">总通道数</span>
                            <span class="monitor-value info">${channels.total}</span>
                        </div>
                        <div class="monitor-item">
                            <span class="monitor-label">空闲通道</span>
                            <span class="monitor-value ${channels.idle > 0 ? 'success' : 'danger'}">${channels.idle}</span>
                        </div>
                        <div class="monitor-item">
                            <span class="monitor-label">使用中</span>
                            <span class="monitor-value warning">${channels.in_use}</span>
                        </div>
                        <div class="monitor-item">
                            <span class="monitor-label">使用率</span>
                            <span class="monitor-value ${channels.total > 0 ? (channels.in_use / channels.total * 100).toFixed(1) + '%' : '0%'}">${channels.total > 0 ? (channels.in_use / channels.total * 100).toFixed(1) + '%' : '0%'}</span>
                        </div>
                    `;
                    document.getElementById('channelStatus').innerHTML = content;
                } else {
                    document.getElementById('channelStatus').innerHTML = '<p class="monitor-value danger">获取失败</p>';
                }
            } catch (error) {
                document.getElementById('channelStatus').innerHTML = '<p class="monitor-value danger">连接错误</p>';
            }
        }

        // 加载代理性能
        async function loadProxyPerformance() {
            try {
                const response = await fetch('/api/v1/proxies/stats/overview');
                const stats = await response.json();
                
                const avgSpeed = stats.avg_speed || 0;
                const speedClass = avgSpeed < 1000 ? 'success' : avgSpeed < 3000 ? 'warning' : 'danger';
                
                const content = `
                    <div class="monitor-item">
                        <span class="monitor-label">平均速度</span>
                        <span class="monitor-value ${speedClass}">${avgSpeed}ms</span>
                    </div>
                    <div class="monitor-item">
                        <span class="monitor-label">成功率</span>
                        <span class="monitor-value ${stats.avg_success_rate > 80 ? 'success' : stats.avg_success_rate > 60 ? 'warning' : 'danger'}">${stats.avg_success_rate}%</span>
                    </div>
                    <div class="monitor-item">
                        <span class="monitor-label">活跃代理</span>
                        <span class="monitor-value info">${stats.active_proxies}</span>
                    </div>
                    <div class="monitor-item">
                        <span class="monitor-label">总使用次数</span>
                        <span class="monitor-value info">${stats.total_usage_count}</span>
                    </div>
                `;
                document.getElementById('proxyPerformance').innerHTML = content;
            } catch (error) {
                document.getElementById('proxyPerformance').innerHTML = '<p class="monitor-value danger">获取失败</p>';
            }
        }

        // 加载地区分布
        async function loadRegionDistribution() {
            try {
                const response = await fetch('/api/v1/proxies/');
                const proxies = await response.json();
                
                const regionCount = {};
                proxies.forEach(proxy => {
                    if (proxy.area) {
                        regionCount[proxy.area] = (regionCount[proxy.area] || 0) + 1;
                    }
                });
                
                const sortedRegions = Object.entries(regionCount)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
                
                let content = '';
                if (sortedRegions.length > 0) {
                    sortedRegions.forEach(([region, count]) => {
                        content += `
                            <div class="monitor-item">
                                <span class="monitor-label">${region}</span>
                                <span class="monitor-value info">${count}</span>
                            </div>
                        `;
                    });
                } else {
                    content = '<p class="monitor-value warning">暂无地区信息</p>';
                }
                
                document.getElementById('regionDistribution').innerHTML = content;
            } catch (error) {
                document.getElementById('regionDistribution').innerHTML = '<p class="monitor-value danger">获取失败</p>';
            }
        }

        // 加载过期预警
        async function loadExpiryWarning() {
            try {
                const response = await fetch('/api/v1/proxies/');
                const proxies = await response.json();
                
                const now = Math.floor(Date.now() / 1000);
                const expiringSoon = proxies.filter(proxy => {
                    if (!proxy.expire_ts) return false;
                    const timeLeft = proxy.expire_ts - now;
                    return timeLeft > 0 && timeLeft < 3600; // 1小时内过期
                });
                
                const expired = proxies.filter(proxy => {
                    if (!proxy.expire_ts) return false;
                    return proxy.expire_ts <= now;
                });
                
                const content = `
                    <div class="monitor-item">
                        <span class="monitor-label">即将过期</span>
                        <span class="monitor-value ${expiringSoon.length > 0 ? 'warning' : 'success'}">${expiringSoon.length}</span>
                    </div>
                    <div class="monitor-item">
                        <span class="monitor-label">已过期</span>
                        <span class="monitor-value ${expired.length > 0 ? 'danger' : 'success'}">${expired.length}</span>
                    </div>
                    <div class="monitor-item">
                        <span class="monitor-label">正常代理</span>
                        <span class="monitor-value success">${proxies.length - expiringSoon.length - expired.length}</span>
                    </div>
                `;
                document.getElementById('expiryWarning').innerHTML = content;
            } catch (error) {
                document.getElementById('expiryWarning').innerHTML = '<p class="monitor-value danger">获取失败</p>';
            }
        }

        // 开始自动刷新
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                loadStats();
                loadProxies();
                loadRealtimeMonitor();
            }, refreshInterval);
            
            document.getElementById('refreshStatus').textContent = '运行中';
            document.getElementById('refreshStatus').style.background = 'rgba(40, 167, 69, 0.3)';
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            document.getElementById('refreshStatus').textContent = '已停止';
            document.getElementById('refreshStatus').style.background = 'rgba(255,255,255,0.2)';
        }

        // 开始通道状态实时更新
        function startChannelStatusUpdate() {
            if (channelStatusInterval) {
                clearInterval(channelStatusInterval);
            }
            
            // 立即更新一次
            updateChannelStatusDisplay();
            
            // 每5秒更新一次通道状态
            channelStatusInterval = setInterval(updateChannelStatusDisplay, 5000);
        }

        // 停止通道状态实时更新
        function stopChannelStatusUpdate() {
            if (channelStatusInterval) {
                clearInterval(channelStatusInterval);
                channelStatusInterval = null;
            }
        }

        // 更新通道状态显示
        async function updateChannelStatusDisplay() {
            try {
                const response = await fetch('/api/v1/qingguo/channels');
                const result = await response.json();
                
                if (result.success) {
                    const channels = result.channels;
                    const channelsElement = document.getElementById('qingguoChannels');
                    
                    // 更新显示内容
                    channelsElement.innerHTML = `
                        <div class="channel-status">
                            <div class="channel-item">
                                <span class="channel-label">总数:</span>
                                <span class="channel-value total">${channels.total}</span>
                            </div>
                            <div class="channel-item">
                                <span class="channel-label">空闲:</span>
                                <span class="channel-value ${channels.idle > 0 ? 'idle' : 'busy'}">${channels.idle}</span>
                            </div>
                            <div class="channel-item">
                                <span class="channel-label">使用中:</span>
                                <span class="channel-value in-use">${channels.in_use}</span>
                            </div>
                        </div>
                    `;
                    
                    // 更新批量提取按钮状态
                    updateBatchExtractButtonState(channels.idle);
                }
            } catch (error) {
                console.error('更新通道状态失败:', error);
            }
        }

        // 更新批量提取按钮状态
        function updateBatchExtractButtonState(idleCount) {
            const batchExtractButton = document.querySelector('.qingguo-card button[onclick="batchExtractQingguoProxies()"]');
            const countInput = document.getElementById('batchExtractCount');
            
            if (batchExtractButton && countInput) {
                const requestedCount = parseInt(countInput.value) || 5;
                
                if (idleCount < requestedCount) {
                    batchExtractButton.disabled = true;
                    batchExtractButton.style.background = '#6c757d';
                    batchExtractButton.title = `通道空闲数不足 (${idleCount}/${requestedCount})`;
                } else {
                    batchExtractButton.disabled = false;
                    batchExtractButton.style.background = '';
                    batchExtractButton.title = '批量提取代理';
                }
            }
        }

        // 从当前状态更新批量提取按钮状态
        async function updateBatchExtractButtonStateFromCurrent() {
            try {
                const response = await fetch('/api/v1/qingguo/channels');
                const result = await response.json();
                
                if (result.success) {
                    const channels = result.channels;
                    updateBatchExtractButtonState(channels.idle || 0);
                }
            } catch (error) {
                console.error('获取通道状态失败:', error);
            }
        }

        // 批量测试代理
        async function batchTestProxies() {
            if (!confirm('确定要批量测试所有代理吗？这可能需要一些时间。')) {
                return;
            }

            try {
                // 获取当前显示的代理列表
                const response = await fetch('/api/v1/proxies/');
                const proxies = await response.json();
                
                if (!proxies || proxies.length === 0) {
                    showError('没有可测试的代理');
                    return;
                }

                showSuccess(`开始批量测试 ${proxies.length} 个代理...`);
                
                let successCount = 0;
                let failCount = 0;
                let totalSpeed = 0;
                
                // 逐个测试代理
                for (let i = 0; i < proxies.length; i++) {
                    const proxy = proxies[i];
                    
                    try {
                        const testResponse = await fetch(`/api/v1/proxies/${proxy.proxy_id}/test`, {
                            method: 'POST'
                        });
                        const testResult = await testResponse.json();
                        
                        if (testResult.success) {
                            successCount++;
                            totalSpeed += testResult.speed;
                        } else {
                            failCount++;
                        }
                        
                        // 显示进度
                        const progress = Math.round((i + 1) / proxies.length * 100);
                        showSuccess(`测试进度: ${progress}% (${i + 1}/${proxies.length}) - 成功: ${successCount}, 失败: ${failCount}`);
                        
                        // 添加延迟避免请求过快
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                    } catch (error) {
                        failCount++;
                        console.error(`测试代理 ${proxy.proxy_id} 失败:`, error);
                    }
                }
                
                const avgSpeed = successCount > 0 ? Math.round(totalSpeed / successCount) : 0;
                const successRate = Math.round((successCount / proxies.length) * 100);
                
                showSuccess(`批量测试完成！\n总计: ${proxies.length}\n成功: ${successCount}\n失败: ${failCount}\n成功率: ${successRate}%\n平均速度: ${avgSpeed}ms`);
                
                // 刷新列表和统计
                loadProxies();
                loadStats();
                loadRealtimeMonitor();
                
            } catch (error) {
                console.error('批量测试失败:', error);
                showError('批量测试失败: ' + error.message);
            }
        }
    </script>
</body>
</html>
