<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦å·ç®¡ç† - MediaCrawler</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .main-content {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .sidebar {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            height: fit-content;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .account-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .account-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .account-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .platform-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }

        .platform-xhs { background: #ff2442; }
        .platform-dy { background: #000000; }
        .platform-ks { background: #ff6600; }
        .platform-bili { background: #00a1d6; }
        .platform-wb { background: #e6162d; }
        .platform-zhihu { background: #0084ff; }
        .platform-tieba { background: #2d78f4; }

        .account-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .account-info {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .account-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-active { background: #28a745; }
        .status-inactive { background: #6c757d; }
        .status-logged-in { background: #28a745; }
        .status-not-logged-in { background: #ffc107; }
        .status-expired { background: #dc3545; }

        .account-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            background: white;
        }

        .form-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            min-height: 80px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .checkbox-input {
            width: 18px;
            height: 18px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .remote-login-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .remote-login-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .remote-login-info {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .remote-login-url {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }
            
            .account-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘¤ è´¦å·ç®¡ç†</h1>
            <p>ç®¡ç†å¤šå¹³å°ç¤¾äº¤åª’ä½“è´¦å·ï¼Œæ”¯æŒè¿œç¨‹ç™»å½•å’Œè‡ªåŠ¨åŒ–æ“ä½œ</p>
        </div>

        <div class="content-wrapper">
            <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
            <div class="main-content">
                <div class="section-title">
                    ğŸ“‹ è´¦å·åˆ—è¡¨
                    <button class="btn btn-primary" onclick="showAddAccountModal()">â• æ·»åŠ è´¦å·</button>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAccounts">-</div>
                        <div class="stat-label">æ€»è´¦å·æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeAccounts">-</div>
                        <div class="stat-label">å¯ç”¨è´¦å·</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="loggedInAccounts">-</div>
                        <div class="stat-label">å·²ç™»å½•</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="supportedPlatforms">-</div>
                        <div class="stat-label">æ”¯æŒå¹³å°</div>
                    </div>
                </div>

                <!-- ç­›é€‰å™¨ -->
                <div style="margin-bottom: 20px;">
                    <select id="platformFilter" class="form-select" onchange="filterAccounts()">
                        <option value="">æ‰€æœ‰å¹³å°</option>
                        <option value="xhs">å°çº¢ä¹¦</option>
                        <option value="dy">æŠ–éŸ³</option>
                        <option value="ks">å¿«æ‰‹</option>
                        <option value="bili">Bç«™</option>
                        <option value="wb">å¾®åš</option>
                        <option value="zhihu">çŸ¥ä¹</option>
                        <option value="tieba">è´´å§</option>
                    </select>
                </div>

                <!-- è´¦å·åˆ—è¡¨ -->
                <div id="accountsContainer" class="account-grid">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <div class="section-title">ğŸ”§ å¿«é€Ÿæ“ä½œ</div>
                
                <div class="form-group">
                    <label class="form-label">å¹³å°é€‰æ‹©</label>
                    <select id="quickPlatform" class="form-select">
                        <option value="">é€‰æ‹©å¹³å°</option>
                        <option value="xhs">å°çº¢ä¹¦</option>
                        <option value="dy">æŠ–éŸ³</option>
                        <option value="ks">å¿«æ‰‹</option>
                        <option value="bili">Bç«™</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">è´¦å·é€‰æ‹©</label>
                    <select id="quickAccount" class="form-select">
                        <option value="">å…ˆé€‰æ‹©å¹³å°</option>
                    </select>
                </div>

                <div class="form-group">
                    <button class="btn btn-success" style="width: 100%;" onclick="startRemoteLogin()">
                        ğŸ–¥ï¸ è¿œç¨‹ç™»å½•
                    </button>
                </div>

                <div class="form-group">
                    <button class="btn btn-warning" style="width: 100%;" onclick="checkLoginStatus()">
                        ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€
                    </button>
                </div>

                <div class="form-group">
                    <button class="btn btn-secondary" style="width: 100%;" onclick="refreshAccounts()">
                        ğŸ”„ åˆ·æ–°è´¦å·åˆ—è¡¨
                    </button>
                </div>

                <!-- è¿œç¨‹ç™»å½•ä¿¡æ¯ -->
                <div class="remote-login-container">
                    <div class="remote-login-title">ğŸ–¥ï¸ è¿œç¨‹æ¡Œé¢ä¿¡æ¯</div>
                    <div class="remote-login-info">
                        <p><strong>VNCåœ°å€:</strong></p>
                        <div class="remote-login-url" id="vncUrl">http://192.168.31.231:6080/vnc.html</div>
                        <p><strong>ä½¿ç”¨è¯´æ˜:</strong></p>
                        <ul style="margin-left: 20px; font-size: 0.9em;">
                            <li>ç‚¹å‡»"è¿œç¨‹ç™»å½•"æŒ‰é’®å¯åŠ¨æµè§ˆå™¨</li>
                            <li>åœ¨VNCçª—å£ä¸­æ“ä½œç™»å½•æµç¨‹</li>
                            <li>æ”¯æŒäºŒç»´ç ç™»å½•å’Œæ»‘åŠ¨éªŒè¯</li>
                            <li>ç™»å½•æˆåŠŸåè‡ªåŠ¨ä¿å­˜Cookie</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è´¦å·æ¨¡æ€æ¡† -->
    <div id="addAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">â• æ·»åŠ æ–°è´¦å·</div>
                <span class="close" onclick="closeModal('addAccountModal')">&times;</span>
            </div>
            
            <form id="addAccountForm">
                <div class="form-group">
                    <label class="form-label">å¹³å° *</label>
                    <select id="newAccountPlatform" class="form-select" required>
                        <option value="">é€‰æ‹©å¹³å°</option>
                        <option value="xhs">å°çº¢ä¹¦</option>
                        <option value="dy">æŠ–éŸ³</option>
                        <option value="ks">å¿«æ‰‹</option>
                        <option value="bili">Bç«™</option>
                        <option value="wb">å¾®åš</option>
                        <option value="zhihu">çŸ¥ä¹</option>
                        <option value="tieba">è´´å§</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">è´¦å·åç§° *</label>
                    <input type="text" id="newAccountName" class="form-input" placeholder="è¯·è¾“å…¥è´¦å·åç§°" required>
                </div>

                <div class="form-group">
                    <label class="form-label">è´¦å·ID</label>
                    <input type="text" id="newAccountId" class="form-input" placeholder="å¯é€‰ï¼Œå¹³å°è´¦å·ID">
                </div>

                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" id="newUsername" class="form-input" placeholder="å¯é€‰ï¼Œç™»å½•ç”¨æˆ·å">
                </div>

                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" id="newPassword" class="form-input" placeholder="å¯é€‰ï¼Œç™»å½•å¯†ç ">
                </div>

                <div class="form-group">
                    <label class="form-label">æ‰‹æœºå·</label>
                    <input type="tel" id="newPhone" class="form-input" placeholder="å¯é€‰ï¼Œæ‰‹æœºå·">
                </div>

                <div class="form-group">
                    <label class="form-label">é‚®ç®±</label>
                    <input type="email" id="newEmail" class="form-input" placeholder="å¯é€‰ï¼Œé‚®ç®±åœ°å€">
                </div>

                <div class="form-group">
                    <label class="form-label">ç™»å½•æ–¹å¼</label>
                    <select id="newLoginMethod" class="form-select">
                        <option value="qrcode">äºŒç»´ç ç™»å½•</option>
                        <option value="phone">æ‰‹æœºå·ç™»å½•</option>
                        <option value="email">é‚®ç®±ç™»å½•</option>
                        <option value="cookie">Cookieç™»å½•</option>
                    </select>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="newIsActive" class="checkbox-input" checked>
                    <label for="newIsActive">å¯ç”¨è´¦å·</label>
                </div>

                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <textarea id="newNotes" class="form-textarea" placeholder="å¯é€‰ï¼Œè´¦å·å¤‡æ³¨ä¿¡æ¯"></textarea>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addAccountModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºè´¦å·</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è¿œç¨‹ç™»å½•æ¨¡æ€æ¡† -->
    <div id="remoteLoginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ–¥ï¸ è¿œç¨‹ç™»å½•</div>
                <span class="close" onclick="closeModal('remoteLoginModal')">&times;</span>
            </div>
            
            <div id="remoteLoginContent">
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©å¹³å°</label>
                    <select id="remoteLoginPlatform" class="form-select">
                        <option value="">é€‰æ‹©å¹³å°</option>
                        <option value="xhs">å°çº¢ä¹¦</option>
                        <option value="dy">æŠ–éŸ³</option>
                        <option value="ks">å¿«æ‰‹</option>
                        <option value="bili">Bç«™</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">é€‰æ‹©è´¦å·</label>
                    <select id="remoteLoginAccount" class="form-select">
                        <option value="">å…ˆé€‰æ‹©å¹³å°</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">ç™»å½•æ–¹å¼</label>
                    <select id="remoteLoginMethod" class="form-select">
                        <option value="qrcode">äºŒç»´ç ç™»å½•</option>
                        <option value="phone">æ‰‹æœºå·ç™»å½•</option>
                        <option value="email">é‚®ç®±ç™»å½•</option>
                    </select>
                </div>

                <div id="remoteLoginStatus" style="display: none;">
                    <div class="success">
                        <strong>ç™»å½•ä¼šè¯å·²åˆ›å»º</strong><br>
                        è¯·åœ¨VNCçª—å£ä¸­å®Œæˆç™»å½•æ“ä½œ
                    </div>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('remoteLoginModal')">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="startRemoteLoginSession()">å¼€å§‹ç™»å½•</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let accounts = [];
        let currentSessionId = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadAccounts();
            loadPlatforms();
            updateQuickAccounts();
        });

        // åŠ è½½è´¦å·åˆ—è¡¨
        async function loadAccounts() {
            try {
                const response = await fetch('/api/v1/accounts/');
                if (response.ok) {
                    const data = await response.json();
                    if (data.code === 200) {
                        accounts = data.data;
                        displayAccounts(accounts);
                        updateStats();
                    } else {
                        showError('åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥: ' + data.message);
                    }
                } else {
                    showError('åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥: HTTP ' + response.status);
                }
            } catch (error) {
                console.error('åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥:', error);
                showError('åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºè´¦å·åˆ—è¡¨
        function displayAccounts(accountsToShow) {
            const container = document.getElementById('accountsContainer');
            
            if (accountsToShow.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— è´¦å·æ•°æ®</div>';
                return;
            }

            container.innerHTML = accountsToShow.map(account => `
                <div class="account-card">
                    <div class="account-header">
                        <span class="platform-badge platform-${account.platform}">${getPlatformName(account.platform)}</span>
                        <div>
                            <button class="btn btn-sm btn-warning" onclick="editAccount(${account.id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAccount(${account.id})">åˆ é™¤</button>
                        </div>
                    </div>
                    
                    <div class="account-name">${account.account_name}</div>
                    <div class="account-info">
                        ${account.account_id ? `ID: ${account.account_id}<br>` : ''}
                        ${account.username ? `ç”¨æˆ·å: ${account.username}<br>` : ''}
                        ${account.phone ? `æ‰‹æœº: ${account.phone}<br>` : ''}
                        ${account.email ? `é‚®ç®±: ${account.email}<br>` : ''}
                        ç™»å½•æ–¹å¼: ${getLoginMethodName(account.login_method)}
                    </div>
                    
                    <div class="account-status">
                        <span class="status-indicator ${account.is_active ? 'status-active' : 'status-inactive'}"></span>
                        <span>${account.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>
                        ${account.login_status ? `
                            <span class="status-indicator status-${account.login_status}"></span>
                            <span>${getLoginStatusName(account.login_status)}</span>
                        ` : ''}
                    </div>
                    
                    <div class="account-actions">
                        <button class="btn btn-sm btn-success" onclick="startRemoteLoginForAccount(${account.id}, '${account.platform}')">
                            ğŸ–¥ï¸ è¿œç¨‹ç™»å½•
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="checkAccountStatus(${account.id}, '${account.platform}')">
                            ğŸ” æ£€æŸ¥çŠ¶æ€
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="viewTokens(${account.id})">
                            ğŸ”‘ æŸ¥çœ‹ä»¤ç‰Œ
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ç­›é€‰è´¦å·
        function filterAccounts() {
            const platformFilter = document.getElementById('platformFilter').value;
            const filteredAccounts = platformFilter 
                ? accounts.filter(account => account.platform === platformFilter)
                : accounts;
            displayAccounts(filteredAccounts);
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('totalAccounts').textContent = accounts.length;
            document.getElementById('activeAccounts').textContent = accounts.filter(a => a.is_active).length;
            document.getElementById('loggedInAccounts').textContent = accounts.filter(a => a.login_status === 'logged_in').length;
            document.getElementById('supportedPlatforms').textContent = new Set(accounts.map(a => a.platform)).size;
        }

        // åŠ è½½å¹³å°åˆ—è¡¨
        async function loadPlatforms() {
            try {
                const response = await fetch('/api/v1/platforms/list');
                if (response.ok) {
                    const data = await response.json();
                    if (data.code === 200) {
                        // å¯ä»¥åœ¨è¿™é‡Œå¤„ç†å¹³å°æ•°æ®
                        console.log('æ”¯æŒçš„å¹³å°:', data.data);
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å¹³å°åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ·»åŠ è´¦å·æ¨¡æ€æ¡†
        function showAddAccountModal() {
            document.getElementById('addAccountModal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // æ·»åŠ è´¦å·è¡¨å•æäº¤
        document.getElementById('addAccountForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                platform: document.getElementById('newAccountPlatform').value,
                account_name: document.getElementById('newAccountName').value,
                account_id: document.getElementById('newAccountId').value || null,
                username: document.getElementById('newUsername').value || null,
                password: document.getElementById('newPassword').value || null,
                phone: document.getElementById('newPhone').value || null,
                email: document.getElementById('newEmail').value || null,
                login_method: document.getElementById('newLoginMethod').value,
                is_active: document.getElementById('newIsActive').checked,
                notes: document.getElementById('newNotes').value || null
            };

            try {
                const response = await fetch('/api/v1/accounts/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.code === 200) {
                        showSuccess('è´¦å·åˆ›å»ºæˆåŠŸï¼');
                        closeModal('addAccountModal');
                        loadAccounts();
                        document.getElementById('addAccountForm').reset();
                    } else {
                        showError('åˆ›å»ºè´¦å·å¤±è´¥: ' + data.message);
                    }
                } else {
                    showError('åˆ›å»ºè´¦å·å¤±è´¥: HTTP ' + response.status);
                }
            } catch (error) {
                console.error('åˆ›å»ºè´¦å·å¤±è´¥:', error);
                showError('åˆ›å»ºè´¦å·å¤±è´¥: ' + error.message);
            }
        });

        // å¼€å§‹è¿œç¨‹ç™»å½•
        async function startRemoteLogin() {
            const platform = document.getElementById('quickPlatform').value;
            const accountId = document.getElementById('quickAccount').value;
            
            if (!platform || !accountId) {
                showError('è¯·å…ˆé€‰æ‹©å¹³å°å’Œè´¦å·');
                return;
            }

            try {
                const response = await fetch('/api/v1/login/remote_start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account_id: parseInt(accountId),
                        login_method: 'qrcode'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.code === 200) {
                        currentSessionId = data.data.session_id;
                        showSuccess('è¿œç¨‹ç™»å½•ä¼šè¯å·²åˆ›å»ºï¼Œè¯·åœ¨VNCçª—å£ä¸­å®Œæˆç™»å½•æ“ä½œ');
                        
                        // æ‰“å¼€VNCçª—å£
                        const vncUrl = document.getElementById('vncUrl').textContent;
                        window.open(vncUrl, '_blank');
                        
                        // å¼€å§‹ç›‘æ§ç™»å½•çŠ¶æ€
                        monitorLoginStatus(currentSessionId);
                    } else {
                        showError('å¯åŠ¨è¿œç¨‹ç™»å½•å¤±è´¥: ' + data.message);
                    }
                } else {
                    showError('å¯åŠ¨è¿œç¨‹ç™»å½•å¤±è´¥: HTTP ' + response.status);
                }
            } catch (error) {
                console.error('å¯åŠ¨è¿œç¨‹ç™»å½•å¤±è´¥:', error);
                showError('å¯åŠ¨è¿œç¨‹ç™»å½•å¤±è´¥: ' + error.message);
            }
        }

        // ç›‘æ§ç™»å½•çŠ¶æ€
        async function monitorLoginStatus(sessionId) {
            const checkStatus = async () => {
                try {
                    const response = await fetch(`/api/v1/login/status/${sessionId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.code === 200) {
                            const status = data.data.status;
                            
                            if (status === 'success') {
                                showSuccess('ç™»å½•æˆåŠŸï¼Cookieå·²ä¿å­˜');
                                loadAccounts(); // åˆ·æ–°è´¦å·åˆ—è¡¨
                                return;
                            } else if (status === 'failed') {
                                showError('ç™»å½•å¤±è´¥: ' + data.data.message);
                                return;
                            }
                            // ç»§ç»­ç›‘æ§
                            setTimeout(checkStatus, 2000);
                        }
                    }
                } catch (error) {
                    console.error('ç›‘æ§ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                }
            };
            
            checkStatus();
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            const platform = document.getElementById('quickPlatform').value;
            const accountId = document.getElementById('quickAccount').value;
            
            if (!platform) {
                showError('è¯·å…ˆé€‰æ‹©å¹³å°');
                return;
            }

            try {
                const response = await fetch('/api/v1/login/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        platform: platform,
                        account_id: accountId ? parseInt(accountId) : null
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.code === 200) {
                        const status = data.data.status;
                        const message = data.data.message;
                        
                        if (status === 'logged_in') {
                            showSuccess('ç™»å½•çŠ¶æ€æ­£å¸¸: ' + message);
                        } else if (status === 'not_logged_in') {
                            showError('æœªç™»å½•: ' + message);
                        } else if (status === 'expired') {
                            showError('ç™»å½•å·²è¿‡æœŸ: ' + message);
                        } else {
                            showError('ç™»å½•çŠ¶æ€æœªçŸ¥: ' + message);
                        }
                    } else {
                        showError('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ' + data.message);
                    }
                } else {
                    showError('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: HTTP ' + response.status);
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                showError('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ' + error.message);
            }
        }

        // åˆ·æ–°è´¦å·åˆ—è¡¨
        function refreshAccounts() {
            loadAccounts();
            showSuccess('è´¦å·åˆ—è¡¨å·²åˆ·æ–°');
        }

        // æ›´æ–°å¿«é€Ÿæ“ä½œä¸­çš„è´¦å·é€‰æ‹©
        function updateQuickAccounts() {
            const platform = document.getElementById('quickPlatform').value;
            const accountSelect = document.getElementById('quickAccount');
            
            accountSelect.innerHTML = '<option value="">é€‰æ‹©è´¦å·</option>';
            
            if (platform) {
                const platformAccounts = accounts.filter(account => account.platform === platform);
                platformAccounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = account.account_name;
                    accountSelect.appendChild(option);
                });
            }
        }

        // ç›‘å¬å¹³å°é€‰æ‹©å˜åŒ–
        document.getElementById('quickPlatform').addEventListener('change', updateQuickAccounts);

        // å·¥å…·å‡½æ•°
        function getPlatformName(platform) {
            const names = {
                'xhs': 'å°çº¢ä¹¦',
                'dy': 'æŠ–éŸ³',
                'ks': 'å¿«æ‰‹',
                'bili': 'Bç«™',
                'wb': 'å¾®åš',
                'zhihu': 'çŸ¥ä¹',
                'tieba': 'è´´å§'
            };
            return names[platform] || platform;
        }

        function getLoginMethodName(method) {
            const names = {
                'qrcode': 'äºŒç»´ç ç™»å½•',
                'phone': 'æ‰‹æœºå·ç™»å½•',
                'email': 'é‚®ç®±ç™»å½•',
                'cookie': 'Cookieç™»å½•'
            };
            return names[method] || method;
        }

        // æ‰“å¼€VNCè¿œç¨‹æ¡Œé¢
        function openVNC() {
            const vncUrl = document.getElementById('vncUrl').textContent;
            if (vncUrl) {
                window.open(vncUrl, '_blank', 'width=1200,height=800');
            } else {
                showError('VNCåœ°å€æœªé…ç½®');
            }
        }

        function getLoginStatusName(status) {
            const names = {
                'logged_in': 'å·²ç™»å½•',
                'not_logged_in': 'æœªç™»å½•',
                'expired': 'å·²è¿‡æœŸ',
                'unknown': 'æœªçŸ¥'
            };
            return names[status] || status;
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.main-content').insertBefore(successDiv, document.querySelector('.section-title'));
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.main-content').insertBefore(errorDiv, document.querySelector('.section-title'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // å…¶ä»–åŠŸèƒ½å‡½æ•°ï¼ˆç¼–è¾‘ã€åˆ é™¤ã€æŸ¥çœ‹ä»¤ç‰Œç­‰ï¼‰
        function editAccount(accountId) {
            // TODO: å®ç°ç¼–è¾‘è´¦å·åŠŸèƒ½
            alert('ç¼–è¾‘è´¦å·åŠŸèƒ½å¼€å‘ä¸­...');
        }

        function deleteAccount(accountId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦å·å—ï¼Ÿ')) {
                // TODO: å®ç°åˆ é™¤è´¦å·åŠŸèƒ½
                alert('åˆ é™¤è´¦å·åŠŸèƒ½å¼€å‘ä¸­...');
            }
        }

        // ä¸ºç‰¹å®šè´¦å·å¯åŠ¨è¿œç¨‹ç™»å½•
        async function startRemoteLoginForAccount(accountId, platform) {
            try {
                const response = await fetch('/api/v1/login/remote_start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account_id: parseInt(accountId),
                        login_method: 'qrcode'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.code === 200) {
                        currentSessionId = data.data.session_id;
                        showSuccess('è¿œç¨‹ç™»å½•ä¼šè¯å·²åˆ›å»ºï¼Œè¯·åœ¨VNCçª—å£ä¸­å®Œæˆç™»å½•æ“ä½œ');
                        
                        // æ‰“å¼€VNCçª—å£
                        const vncUrl = document.getElementById('vncUrl').textContent;
                        window.open(vncUrl, '_blank');
                        
                        // å¼€å§‹ç›‘æ§ç™»å½•çŠ¶æ€
                        monitorLoginStatus(currentSessionId);
                    } else {
                        showError('å¯åŠ¨è¿œç¨‹ç™»å½•å¤±è´¥: ' + data.message);
                    }
                } else {
                    showError('å¯åŠ¨è¿œç¨‹ç™»å½•å¤±è´¥: HTTP ' + response.status);
                }
            } catch (error) {
                console.error('å¯åŠ¨è¿œç¨‹ç™»å½•å¤±è´¥:', error);
                showError('å¯åŠ¨è¿œç¨‹ç™»å½•å¤±è´¥: ' + error.message);
            }
        }

        // æ£€æŸ¥ç‰¹å®šè´¦å·çŠ¶æ€
        async function checkAccountStatus(accountId, platform) {
            try {
                const response = await fetch('/api/v1/login/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        platform: platform,
                        account_id: parseInt(accountId)
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.code === 200) {
                        const status = data.data.status;
                        const message = data.data.message;
                        
                        if (status === 'logged_in') {
                            showSuccess('ç™»å½•çŠ¶æ€æ­£å¸¸: ' + message);
                        } else if (status === 'not_logged_in') {
                            showError('æœªç™»å½•: ' + message);
                        } else if (status === 'expired') {
                            showError('ç™»å½•å·²è¿‡æœŸ: ' + message);
                        } else {
                            showError('ç™»å½•çŠ¶æ€æœªçŸ¥: ' + message);
                        }
                    } else {
                        showError('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ' + data.message);
                    }
                } else {
                    showError('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: HTTP ' + response.status);
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                showError('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ' + error.message);
            }
        }

        // æŸ¥çœ‹è´¦å·ä»¤ç‰Œ
        async function viewTokens(accountId) {
            try {
                const response = await fetch(`/api/v1/login/tokens/${accountId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.code === 200) {
                        const tokens = data.data;
                        if (tokens.length === 0) {
                            alert('è¯¥è´¦å·æš‚æ— ç™»å½•å‡­è¯');
                            return;
                        }
                        
                        // åˆ›å»ºä»¤ç‰Œè¯¦æƒ…å¼¹çª—
                        let tokenInfo = 'ç™»å½•å‡­è¯è¯¦æƒ…ï¼š\n\n';
                        tokens.forEach((token, index) => {
                            tokenInfo += `${index + 1}. å¹³å°: ${getPlatformName(token.platform)}\n`;
                            tokenInfo += `   ç±»å‹: ${token.token_type}\n`;
                            tokenInfo += `   çŠ¶æ€: ${token.is_valid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}\n`;
                            tokenInfo += `   åˆ›å»ºæ—¶é—´: ${token.created_at}\n`;
                            if (token.expires_at) {
                                tokenInfo += `   è¿‡æœŸæ—¶é—´: ${token.expires_at}\n`;
                            }
                            if (token.last_used_at) {
                                tokenInfo += `   æœ€åä½¿ç”¨: ${token.last_used_at}\n`;
                            }
                            tokenInfo += '\n';
                        });
                        
                        alert(tokenInfo);
                    } else {
                        showError('è·å–ä»¤ç‰Œå¤±è´¥: ' + data.message);
                    }
                } else {
                    showError('è·å–ä»¤ç‰Œå¤±è´¥: HTTP ' + response.status);
                }
            } catch (error) {
                console.error('è·å–ä»¤ç‰Œå¤±è´¥:', error);
                showError('è·å–ä»¤ç‰Œå¤±è´¥: ' + error.message);
            }
        }

        function checkAccountStatus(accountId, platform) {
            // TODO: å®ç°æ£€æŸ¥è´¦å·çŠ¶æ€åŠŸèƒ½
            alert('æ£€æŸ¥è´¦å·çŠ¶æ€åŠŸèƒ½å¼€å‘ä¸­...');
        }

        function viewTokens(accountId) {
            // TODO: å®ç°æŸ¥çœ‹ä»¤ç‰ŒåŠŸèƒ½
            alert('æŸ¥çœ‹ä»¤ç‰ŒåŠŸèƒ½å¼€å‘ä¸­...');
        }
    </script>
</body>
</html> 