# MediaCrawler 多平台并行抓取使用指南

## 概述

MediaCrawler 支持多平台并行抓取功能，可以同时对多个平台（小红书、抖音、快手、B站、微博、贴吧、知乎）进行内容抓取，统一结果格式输出。

## 功能特点

- **并发抓取**: 多个平台同时进行抓取，提高效率
- **统一格式**: 所有平台的结果统一为相同的数据结构
- **任务管理**: 支持任务状态跟踪、进度监控
- **错误处理**: 单个平台失败不影响其他平台
- **灵活配置**: 支持自定义抓取参数

## 使用方法

### 1. 通过Web界面使用

1. 启动API服务器：
```bash
ENV=local python start_with_env.py
```

2. 打开浏览器访问：`http://localhost:8100`

3. 点击"多平台爬取"标签页

4. 配置抓取参数：
   - 选择要抓取的平台（可多选）
   - 输入搜索关键词
   - 设置每个平台的最大抓取数量
   - 选择是否抓取评论
   - 选择保存格式（JSON/CSV）

5. 点击"开始多平台爬取"按钮

6. 记录返回的任务ID，用于后续查询状态

### 2. 通过API接口使用

#### 启动多平台抓取任务

```bash
curl -X POST "http://localhost:8100/api/v1/multi-platform/start" \
  -H "Content-Type: application/json" \
  -d '{
    "platforms": ["xhs", "dy", "ks"],
    "keywords": "美食",
    "max_count_per_platform": 10,
    "enable_comments": false,
    "enable_images": false,
    "save_format": "json"
  }'
```

#### 查询任务状态

```bash
curl "http://localhost:8100/api/v1/multi-platform/status/{task_id}"
```

#### 获取任务结果

```bash
# 表格格式
curl "http://localhost:8100/api/v1/multi-platform/results/{task_id}?format_type=table"

# JSON格式
curl "http://localhost:8100/api/v1/multi-platform/results/{task_id}?format_type=json"
```

#### 列出所有多平台任务

```bash
curl "http://localhost:8100/api/v1/multi-platform/tasks"
```

### 3. 通过Python代码使用

```python
import requests
import json

# API基础URL
BASE_URL = "http://localhost:8100/api/v1"

# 启动多平台抓取任务
def start_multi_platform_crawler():
    url = f"{BASE_URL}/multi-platform/start"
    data = {
        "platforms": ["xhs", "dy", "ks"],
        "keywords": "美食",
        "max_count_per_platform": 10,
        "enable_comments": False,
        "enable_images": False,
        "save_format": "json"
    }
    
    response = requests.post(url, json=data)
    if response.status_code == 200:
        result = response.json()
        print(f"任务已启动，任务ID: {result['task_id']}")
        return result['task_id']
    else:
        print(f"启动失败: {response.text}")
        return None

# 查询任务状态
def check_task_status(task_id):
    url = f"{BASE_URL}/multi-platform/status/{task_id}"
    response = requests.get(url)
    if response.status_code == 200:
        return response.json()
    else:
        print(f"查询失败: {response.text}")
        return None

# 获取任务结果
def get_task_results(task_id, format_type="table"):
    url = f"{BASE_URL}/multi-platform/results/{task_id}?format_type={format_type}"
    response = requests.get(url)
    if response.status_code == 200:
        return response.json()
    else:
        print(f"获取结果失败: {response.text}")
        return None

# 使用示例
if __name__ == "__main__":
    # 启动任务
    task_id = start_multi_platform_crawler()
    
    if task_id:
        # 等待任务完成（实际使用时应该轮询检查状态）
        import time
        time.sleep(5)
        
        # 查询状态
        status = check_task_status(task_id)
        if status:
            print(f"任务状态: {status['status']}")
        
        # 获取结果
        results = get_task_results(task_id, "json")
        if results:
            print(f"抓取到 {results['total_count']} 条内容")
```

## 支持的平台

| 平台代码 | 平台名称 | 支持功能 |
|---------|---------|---------|
| xhs | 小红书 | 笔记搜索、评论抓取 |
| dy | 抖音 | 视频搜索、评论抓取 |
| ks | 快手 | 视频搜索、评论抓取 |
| bili | B站 | 视频搜索、评论抓取 |
| wb | 微博 | 内容搜索、评论抓取 |
| tieba | 贴吧 | 帖子搜索、回复抓取 |
| zhihu | 知乎 | 问答搜索、评论抓取 |

## 数据格式

### 统一结果格式

所有平台的结果都统一为以下格式：

```json
{
  "platform": "xhs",
  "platform_name": "小红书",
  "content_id": "123456789",
  "title": "内容标题",
  "author": "作者名称",
  "publish_time": "2024-01-01 12:00:00",
  "content": "内容正文",
  "likes": 100,
  "comments": 50,
  "shares": 20,
  "views": 1000,
  "download_links": ["http://example.com/image1.jpg"],
  "tags": ["标签1", "标签2"],
  "url": "https://example.com/content/123456789"
}
```

### 任务状态格式

```json
{
  "task_id": "uuid-string",
  "status": "completed",
  "platforms": ["xhs", "dy", "ks"],
  "keywords": "美食",
  "progress": {
    "total": 3,
    "completed": 3,
    "failed": 0,
    "pending": 0
  },
  "results": {
    "xhs": 10,
    "dy": 8,
    "ks": 12
  },
  "errors": {},
  "created_at": "2024-01-01T12:00:00",
  "started_at": "2024-01-01T12:00:01",
  "completed_at": "2024-01-01T12:05:00"
}
```

## 注意事项

1. **登录状态**: 某些平台可能需要登录才能抓取，建议先进行登录
2. **请求频率**: 请合理控制抓取频率，避免被平台限制
3. **数据量**: 大量数据抓取时建议分批进行
4. **网络环境**: 确保网络连接稳定，某些平台可能需要代理
5. **存储空间**: 抓取的数据会保存在本地，注意磁盘空间

## 故障排除

### 常见问题

1. **任务启动失败**
   - 检查API服务器是否正常运行
   - 确认选择的平台是否支持
   - 检查网络连接

2. **抓取结果为空**
   - 确认关键词是否正确
   - 检查平台是否有反爬虫机制
   - 尝试减少抓取数量

3. **任务状态异常**
   - 检查任务ID是否正确
   - 查看服务器日志获取详细错误信息

### 日志查看

API服务器启动时会显示详细的日志信息，包括：
- 数据库初始化状态
- 模块加载状态
- 任务执行进度
- 错误信息

如果遇到问题，请查看控制台输出的日志信息进行排查。 