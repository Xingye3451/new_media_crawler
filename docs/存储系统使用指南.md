# MediaCrawler å­˜å‚¨ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

MediaCrawler å­˜å‚¨ç³»ç»Ÿé‡‡ç”¨**æ··åˆå­˜å‚¨ç­–ç•¥**ï¼Œæ ¹æ®æ–‡ä»¶å¤§å°è‡ªåŠ¨é€‰æ‹©å­˜å‚¨ä½ç½®ï¼š
- **å°æ–‡ä»¶ï¼ˆâ‰¤10MBï¼‰**ï¼šå­˜å‚¨åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
- **å¤§æ–‡ä»¶ï¼ˆ>10MBï¼‰**ï¼šå­˜å‚¨åˆ° MinIO å¯¹è±¡å­˜å‚¨
- **å…ƒæ•°æ®**ï¼šç»Ÿä¸€å­˜å‚¨åˆ° MySQL æ•°æ®åº“

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### å­˜å‚¨ç­–ç•¥
```
æ–‡ä»¶å¤§å°åˆ¤æ–­ â†’ å­˜å‚¨ä½ç½®é€‰æ‹© â†’ æ–‡ä»¶ä¿å­˜ â†’ å…ƒæ•°æ®è®°å½•
     â†“              â†“            â†“         â†“
  â‰¤10MB â†’ æœ¬åœ°å­˜å‚¨    >10MB â†’ MinIOå­˜å‚¨   æ–‡ä»¶å“ˆå¸Œè®¡ç®—   æ•°æ®åº“è®°å½•
```

### æ ¸å¿ƒç»„ä»¶
- **StorageManager**: æ··åˆå­˜å‚¨ç®¡ç†å™¨
- **VideoStorageManager**: è§†é¢‘å­˜å‚¨ç®¡ç†å™¨
- **VideoMetadataManager**: å…ƒæ•°æ®ç®¡ç†å™¨
- **MinIO**: å¯¹è±¡å­˜å‚¨æœåŠ¡
- **MySQL**: å…ƒæ•°æ®æ•°æ®åº“

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨å­˜å‚¨æœåŠ¡

```bash
# å¯åŠ¨ MinIO å’Œ MySQL æœåŠ¡
docker-compose -f docker-compose.storage.yml up -d

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.storage.yml ps
```

### 2. é…ç½®å­˜å‚¨å‚æ•°

ç¼–è¾‘ç›¸åº”ç¯å¢ƒçš„é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ `config/config_local.yaml`ï¼š

```yaml
# å­˜å‚¨é…ç½®
storage:
  # æœ¬åœ°å­˜å‚¨é…ç½®
  local_base_path: "./data"
  small_file_threshold: 10485760  # 10MB
  
  # MinIOé…ç½®
  enable_minio: true
  minio_endpoint: "192.168.31.231:9000"
  minio_access_key: "minioadmin"
  minio_secret_key: "minioadmin"
  minio_secure: false
  minio_bucket: "mediacrawler-videos"
  
  # æ•°æ®åº“é…ç½®
  database_url: "mysql+pymysql://aiuser:edcghj98578@192.168.31.231:3306/mediacrawler"
  pool_size: 10
  max_overflow: 20
  pool_timeout: 30
  pool_recycle: 3600
  
  # æ–‡ä»¶ç®¡ç†é…ç½®
  naming_pattern: "{platform}/{date}/{content_id}/{filename}"
  date_format: "%Y/%m/%d"
  supported_formats:
    - "mp4"
    - "avi"
    - "mov"
    - "mkv"
    - "flv" 
    - "webm"
    - "m4v"
    - "3gp"
  
  # æ–‡ä»¶å¤§å°é™åˆ¶
  max_file_size: 1073741824  # 1GB
  min_file_size: 1024  # 1KB
  
  # é‡å¤æ–‡ä»¶å¤„ç†
  duplicate_check: true
  duplicate_strategy: "skip"
  
  # æ–‡ä»¶æ¸…ç†ç­–ç•¥
  cleanup:
    enabled: false
    retention_days: 30
    cleanup_interval_hours: 24
  
  # æ€§èƒ½ä¼˜åŒ–é…ç½®
  max_concurrent_downloads: 5
  chunk_size: 8192
  download_timeout: 300
  max_retries: 3
  retry_delay: 5
  
  # ç›‘æ§é…ç½®
  storage_usage_threshold: 0.8  # 80%
  file_count_threshold: 10000
  monitor_interval: 3600
```

### 3. ä½¿ç”¨å­˜å‚¨ç®¡ç†å™¨

```python
from video_storage_manager import VideoStorageManager

async def download_video():
    video_info = {
        "title": "æµ‹è¯•è§†é¢‘",
        "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è§†é¢‘",
        "author": "æµ‹è¯•ä½œè€…",
        "duration": 120.5,
        "width": 1920,
        "height": 1080,
        "format": "mp4"
    }
    
    async with VideoStorageManager() as vsm:
        result = await vsm.download_and_store_video(
            video_url="https://example.com/video.mp4",
            platform="douyin",
            content_id="test_123",
            video_info=video_info
        )
        print(f"å­˜å‚¨ç»“æœ: {result}")
```

## ğŸ“ æ–‡ä»¶ç»„ç»‡ç»“æ„

### æœ¬åœ°å­˜å‚¨ç»“æ„
```
/app/data/
â”œâ”€â”€ small_files/
â”‚   â”œâ”€â”€ douyin/
â”‚   â”‚   â””â”€â”€ 2024/04/05/
â”‚   â”‚       â””â”€â”€ content_id/
â”‚   â”‚           â””â”€â”€ video.mp4
â”‚   â””â”€â”€ xhs/
â”‚       â””â”€â”€ 2024/04/05/
â”‚           â””â”€â”€ content_id/
â”‚               â””â”€â”€ video.mp4
```

### MinIO å­˜å‚¨ç»“æ„
```
mediacrawler-videos/
â”œâ”€â”€ douyin/
â”‚   â””â”€â”€ 2024/04/05/
â”‚       â””â”€â”€ content_id/
â”‚           â””â”€â”€ video.mp4
â””â”€â”€ xhs/
    â””â”€â”€ 2024/04/05/
        â””â”€â”€ content_id/
            â””â”€â”€ video.mp4
```

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# å­˜å‚¨é…ç½®
export STORAGE_LOCAL_BASE_PATH="/app/data"
export STORAGE_SMALL_FILE_THRESHOLD="10485760"
export STORAGE_ENABLE_MINIO="true"
export STORAGE_MINIO_ENDPOINT="localhost:9000"
export STORAGE_MINIO_ACCESS_KEY="minioadmin"
export STORAGE_MINIO_SECRET_KEY="minioadmin"
export STORAGE_MINIO_BUCKET="mediacrawler-videos"
export STORAGE_DATABASE_URL="mysql+pymysql://root:password@localhost:3306/mediacrawler"
```

### é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§
1. ç¯å¢ƒå˜é‡ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. YAML é…ç½®æ–‡ä»¶
3. JSON é…ç½®æ–‡ä»¶
4. é»˜è®¤é…ç½®ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### video_metadata è¡¨
å­˜å‚¨è§†é¢‘çš„å…ƒæ•°æ®ä¿¡æ¯ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | INT | ä¸»é”®ID |
| platform | VARCHAR(50) | å¹³å°åç§° |
| content_id | VARCHAR(100) | å†…å®¹ID |
| title | VARCHAR(500) | è§†é¢‘æ ‡é¢˜ |
| storage_type | VARCHAR(20) | å­˜å‚¨ç±»å‹ |
| file_path | VARCHAR(500) | æ–‡ä»¶è·¯å¾„ |
| file_size | INT | æ–‡ä»¶å¤§å° |
| file_hash | VARCHAR(64) | æ–‡ä»¶å“ˆå¸Œå€¼ |

### å…¶ä»–ç›¸å…³è¡¨
- `storage_statistics`: å­˜å‚¨ç»Ÿè®¡ä¿¡æ¯
- `download_tasks`: ä¸‹è½½ä»»åŠ¡ç®¡ç†
- `file_access_logs`: æ–‡ä»¶è®¿é—®æ—¥å¿—

## ğŸ” ä½¿ç”¨ç¤ºä¾‹

### 1. å•ä¸ªè§†é¢‘ä¸‹è½½

```python
import asyncio
from video_storage_manager import VideoStorageManager

async def download_single_video():
    async with VideoStorageManager() as vsm:
        result = await vsm.download_and_store_video(
            video_url="https://example.com/video.mp4",
            platform="douyin",
            content_id="test_123",
            video_info={
                "title": "æµ‹è¯•è§†é¢‘",
                "author": "æµ‹è¯•ä½œè€…",
                "duration": 120.5
            }
        )
        print(f"ä¸‹è½½ç»“æœ: {result}")

asyncio.run(download_single_video())
```

### 2. æ‰¹é‡è§†é¢‘ä¸‹è½½

```python
async def batch_download():
    video_list = [
        {
            "url": "https://example.com/video1.mp4",
            "platform": "douyin",
            "content_id": "test_1",
            "video_info": {"title": "è§†é¢‘1", "author": "ä½œè€…1"}
        },
        {
            "url": "https://example.com/video2.mp4",
            "platform": "douyin",
            "content_id": "test_2",
            "video_info": {"title": "è§†é¢‘2", "author": "ä½œè€…2"}
        }
    ]
    
    async with VideoStorageManager() as vsm:
        results = await vsm.batch_download_videos(video_list, max_concurrent=3)
        for result in results:
            print(f"æ‰¹é‡ä¸‹è½½ç»“æœ: {result}")
```

### 3. è§†é¢‘ä¿¡æ¯æŸ¥è¯¢

```python
async def query_videos():
    async with VideoStorageManager() as vsm:
        # åˆ—å‡ºè§†é¢‘
        videos = await vsm.list_videos(platform="douyin", limit=10)
        print(f"è§†é¢‘åˆ—è¡¨: {videos}")
        
        # æœç´¢è§†é¢‘
        search_results = await vsm.search_videos("æµ‹è¯•", platform="douyin")
        print(f"æœç´¢ç»“æœ: {search_results}")
        
        # è·å–å•ä¸ªè§†é¢‘ä¿¡æ¯
        video_info = await vsm.get_video_info(metadata_id=1)
        print(f"è§†é¢‘ä¿¡æ¯: {video_info}")
```

### 4. å­˜å‚¨ç»Ÿè®¡

```python
async def get_statistics():
    async with VideoStorageManager() as vsm:
        stats = await vsm.get_storage_statistics()
        print(f"å­˜å‚¨ç»Ÿè®¡: {stats}")
```

## ğŸŒ æ–‡ä»¶è®¿é—®

### æœ¬åœ°æ–‡ä»¶è®¿é—®
- **URLæ ¼å¼**: `http://localhost/files/{platform}/{date}/{content_id}/{filename}`
- **ç¤ºä¾‹**: `http://localhost/files/douyin/2024/04/05/test_123/video.mp4`

### MinIO æ–‡ä»¶è®¿é—®
- **APIç«¯å£**: `http://localhost:9000`
- **æ§åˆ¶å°**: `http://localhost:9001`
- **é¢„ç­¾åURL**: é€šè¿‡ MinIO API ç”Ÿæˆä¸´æ—¶è®¿é—®é“¾æ¥

### Nginx ä»£ç†è®¿é—®
- **æœ¬åœ°æ–‡ä»¶**: `http://localhost/files/`
- **MinIO API**: `http://localhost/minio/`
- **MinIO æ§åˆ¶å°**: `http://localhost/minio-console/`

## ğŸ”’ å®‰å…¨é…ç½®

### MinIO å®‰å…¨è®¾ç½®

```yaml
# ç”Ÿäº§ç¯å¢ƒé…ç½®
storage:
  minio_secure: true  # å¯ç”¨HTTPS
  minio_access_key: "your_access_key"
  minio_secret_key: "your_secret_key"
```

### æ–‡ä»¶è®¿é—®æ§åˆ¶

```nginx
# Nginx è®¿é—®æ§åˆ¶
location /files/ {
    # æ·»åŠ è®¿é—®æ§åˆ¶
    allow 192.168.1.0/24;
    deny all;
    
    # æ·»åŠ è®¤è¯
    auth_basic "Restricted Access";
    auth_basic_user_file /etc/nginx/.htpasswd;
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶å‘ä¸‹è½½æ§åˆ¶
```python
# é…ç½®å¹¶å‘æ•°
storage:
  max_concurrent_downloads: 5
  download_timeout: 300
```

### 2. åˆ†å—ä¸‹è½½
```python
# é…ç½®åˆ†å—å¤§å°
storage:
  chunk_size: 8192  # 8KB
```

### 3. ç¼“å­˜ç­–ç•¥
```python
# å¯ç”¨æ–‡ä»¶ç¼“å­˜
storage:
  enable_cache: true
  cache_ttl: 3600  # 1å°æ—¶
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **MinIO è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥ MinIO æœåŠ¡çŠ¶æ€
   docker-compose -f docker-compose.storage.yml ps
   
   # æŸ¥çœ‹ MinIO æ—¥å¿—
   docker-compose -f docker-compose.storage.yml logs minio
   ```

2. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥ MySQL æœåŠ¡çŠ¶æ€
   docker-compose -f docker-compose.storage.yml ps mysql
   
   # æµ‹è¯•æ•°æ®åº“è¿æ¥
   mysql -h localhost -P 3306 -u root -p
   ```

3. **æ–‡ä»¶æƒé™é—®é¢˜**
   ```bash
   # æ£€æŸ¥ç›®å½•æƒé™
   ls -la /app/data/
   
   # ä¿®å¤æƒé™
   chmod -R 755 /app/data/
   ```

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/mediacrawler.log

# æŸ¥çœ‹ Nginx æ—¥å¿—
docker-compose -f docker-compose.storage.yml logs nginx

# æŸ¥çœ‹ MinIO æ—¥å¿—
docker-compose -f docker-compose.storage.yml logs minio
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ–‡ä»¶å‘½åè§„èŒƒ
- ä½¿ç”¨å¹³å°ã€æ—¥æœŸã€å†…å®¹IDçš„å±‚æ¬¡ç»“æ„
- é¿å…ç‰¹æ®Šå­—ç¬¦å’Œä¸­æ–‡æ–‡ä»¶å
- ä¿æŒæ–‡ä»¶åçš„ä¸€è‡´æ€§

### 2. å­˜å‚¨ç­–ç•¥é€‰æ‹©
- å°æ–‡ä»¶ï¼ˆ<10MBï¼‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨
- å¤§æ–‡ä»¶ï¼ˆ>10MBï¼‰ä½¿ç”¨ MinIO å­˜å‚¨
- æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´é˜ˆå€¼

### 3. æ•°æ®å¤‡ä»½
- å®šæœŸå¤‡ä»½ MySQL æ•°æ®åº“
- é…ç½® MinIO çš„ç‰ˆæœ¬æ§åˆ¶
- å»ºç«‹æ–‡ä»¶å¤‡ä»½ç­–ç•¥

### 4. ç›‘æ§å‘Šè­¦
- ç›‘æ§å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡
- è®¾ç½®æ–‡ä»¶æ•°é‡å‘Šè­¦
- ç›‘æ§ä¸‹è½½æˆåŠŸç‡

## ğŸ”„ è¿ç§»å’Œå‡çº§

### ä»æœ¬åœ°å­˜å‚¨è¿ç§»åˆ° MinIO

```python
async def migrate_to_minio():
    async with VideoStorageManager() as vsm:
        # è·å–æ‰€æœ‰æœ¬åœ°æ–‡ä»¶
        local_videos = await vsm.list_videos()
        
        for video in local_videos:
            if video["storage_type"] == "local":
                # è¿ç§»åˆ° MinIO
                await vsm.migrate_to_minio(video["id"])
```

### é…ç½®å‡çº§

```bash
# å¤‡ä»½å½“å‰é…ç½®
cp config/config_local.yaml config/config_local.yaml.backup

# æ›´æ–°é…ç½®
# ç¼–è¾‘ç›¸åº”ç¯å¢ƒçš„é…ç½®æ–‡ä»¶ï¼Œå¦‚ config/config_local.yaml

# é‡å¯æœåŠ¡
docker-compose -f docker-compose.storage.yml restart
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
3. åœ¨é¡¹ç›® Issues ä¸­æäº¤é—®é¢˜
4. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

---

**æ³¨æ„**: æœ¬å­˜å‚¨ç³»ç»Ÿä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œè¯·éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„å’Œå¹³å°ä½¿ç”¨æ¡æ¬¾ã€‚ 