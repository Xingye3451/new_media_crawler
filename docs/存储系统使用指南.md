# MediaCrawler 存储系统使用指南

## 📋 概述

MediaCrawler 存储系统采用**混合存储策略**，根据文件大小自动选择存储位置：
- **小文件（≤10MB）**：存储到本地文件系统
- **大文件（>10MB）**：存储到 MinIO 对象存储
- **元数据**：统一存储到 MySQL 数据库

## 🏗️ 架构设计

### 存储策略
```
文件大小判断 → 存储位置选择 → 文件保存 → 元数据记录
     ↓              ↓            ↓         ↓
  ≤10MB → 本地存储    >10MB → MinIO存储   文件哈希计算   数据库记录
```

### 核心组件
- **StorageManager**: 混合存储管理器
- **VideoStorageManager**: 视频存储管理器
- **VideoMetadataManager**: 元数据管理器
- **MinIO**: 对象存储服务
- **MySQL**: 元数据数据库

## 🚀 快速开始

### 1. 启动存储服务

```bash
# 启动 MinIO 和 MySQL 服务
docker-compose -f docker-compose.storage.yml up -d

# 检查服务状态
docker-compose -f docker-compose.storage.yml ps
```

### 2. 配置存储参数

编辑相应环境的配置文件，例如 `config/config_local.yaml`：

```yaml
# 存储配置
storage:
  # 本地存储配置
  local_base_path: "./data"
  small_file_threshold: 10485760  # 10MB
  
  # MinIO配置
  enable_minio: true
  minio_endpoint: "192.168.31.231:9000"
  minio_access_key: "minioadmin"
  minio_secret_key: "minioadmin"
  minio_secure: false
  minio_bucket: "mediacrawler-videos"
  
  # 数据库配置
  database_url: "mysql+pymysql://aiuser:edcghj98578@192.168.31.231:3306/mediacrawler"
  pool_size: 10
  max_overflow: 20
  pool_timeout: 30
  pool_recycle: 3600
  
  # 文件管理配置
  naming_pattern: "{platform}/{date}/{content_id}/{filename}"
  date_format: "%Y/%m/%d"
  supported_formats:
    - "mp4"
    - "avi"
    - "mov"
    - "mkv"
    - "flv" 
    - "webm"
    - "m4v"
    - "3gp"
  
  # 文件大小限制
  max_file_size: 1073741824  # 1GB
  min_file_size: 1024  # 1KB
  
  # 重复文件处理
  duplicate_check: true
  duplicate_strategy: "skip"
  
  # 文件清理策略
  cleanup:
    enabled: false
    retention_days: 30
    cleanup_interval_hours: 24
  
  # 性能优化配置
  max_concurrent_downloads: 5
  chunk_size: 8192
  download_timeout: 300
  max_retries: 3
  retry_delay: 5
  
  # 监控配置
  storage_usage_threshold: 0.8  # 80%
  file_count_threshold: 10000
  monitor_interval: 3600
```

### 3. 使用存储管理器

```python
from video_storage_manager import VideoStorageManager

async def download_video():
    video_info = {
        "title": "测试视频",
        "description": "这是一个测试视频",
        "author": "测试作者",
        "duration": 120.5,
        "width": 1920,
        "height": 1080,
        "format": "mp4"
    }
    
    async with VideoStorageManager() as vsm:
        result = await vsm.download_and_store_video(
            video_url="https://example.com/video.mp4",
            platform="douyin",
            content_id="test_123",
            video_info=video_info
        )
        print(f"存储结果: {result}")
```

## 📁 文件组织结构

### 本地存储结构
```
/app/data/
├── small_files/
│   ├── douyin/
│   │   └── 2024/04/05/
│   │       └── content_id/
│   │           └── video.mp4
│   └── xhs/
│       └── 2024/04/05/
│           └── content_id/
│               └── video.mp4
```

### MinIO 存储结构
```
mediacrawler-videos/
├── douyin/
│   └── 2024/04/05/
│       └── content_id/
│           └── video.mp4
└── xhs/
    └── 2024/04/05/
        └── content_id/
            └── video.mp4
```

## 🔧 配置说明

### 环境变量配置

```bash
# 存储配置
export STORAGE_LOCAL_BASE_PATH="/app/data"
export STORAGE_SMALL_FILE_THRESHOLD="10485760"
export STORAGE_ENABLE_MINIO="true"
export STORAGE_MINIO_ENDPOINT="localhost:9000"
export STORAGE_MINIO_ACCESS_KEY="minioadmin"
export STORAGE_MINIO_SECRET_KEY="minioadmin"
export STORAGE_MINIO_BUCKET="mediacrawler-videos"
export STORAGE_DATABASE_URL="mysql+pymysql://root:password@localhost:3306/mediacrawler"
```

### 配置文件优先级
1. 环境变量（最高优先级）
2. YAML 配置文件
3. JSON 配置文件
4. 默认配置（最低优先级）

## 📊 数据库表结构

### video_metadata 表
存储视频的元数据信息：

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键ID |
| platform | VARCHAR(50) | 平台名称 |
| content_id | VARCHAR(100) | 内容ID |
| title | VARCHAR(500) | 视频标题 |
| storage_type | VARCHAR(20) | 存储类型 |
| file_path | VARCHAR(500) | 文件路径 |
| file_size | INT | 文件大小 |
| file_hash | VARCHAR(64) | 文件哈希值 |

### 其他相关表
- `storage_statistics`: 存储统计信息
- `download_tasks`: 下载任务管理
- `file_access_logs`: 文件访问日志

## 🔍 使用示例

### 1. 单个视频下载

```python
import asyncio
from video_storage_manager import VideoStorageManager

async def download_single_video():
    async with VideoStorageManager() as vsm:
        result = await vsm.download_and_store_video(
            video_url="https://example.com/video.mp4",
            platform="douyin",
            content_id="test_123",
            video_info={
                "title": "测试视频",
                "author": "测试作者",
                "duration": 120.5
            }
        )
        print(f"下载结果: {result}")

asyncio.run(download_single_video())
```

### 2. 批量视频下载

```python
async def batch_download():
    video_list = [
        {
            "url": "https://example.com/video1.mp4",
            "platform": "douyin",
            "content_id": "test_1",
            "video_info": {"title": "视频1", "author": "作者1"}
        },
        {
            "url": "https://example.com/video2.mp4",
            "platform": "douyin",
            "content_id": "test_2",
            "video_info": {"title": "视频2", "author": "作者2"}
        }
    ]
    
    async with VideoStorageManager() as vsm:
        results = await vsm.batch_download_videos(video_list, max_concurrent=3)
        for result in results:
            print(f"批量下载结果: {result}")
```

### 3. 视频信息查询

```python
async def query_videos():
    async with VideoStorageManager() as vsm:
        # 列出视频
        videos = await vsm.list_videos(platform="douyin", limit=10)
        print(f"视频列表: {videos}")
        
        # 搜索视频
        search_results = await vsm.search_videos("测试", platform="douyin")
        print(f"搜索结果: {search_results}")
        
        # 获取单个视频信息
        video_info = await vsm.get_video_info(metadata_id=1)
        print(f"视频信息: {video_info}")
```

### 4. 存储统计

```python
async def get_statistics():
    async with VideoStorageManager() as vsm:
        stats = await vsm.get_storage_statistics()
        print(f"存储统计: {stats}")
```

## 🌐 文件访问

### 本地文件访问
- **URL格式**: `http://localhost/files/{platform}/{date}/{content_id}/{filename}`
- **示例**: `http://localhost/files/douyin/2024/04/05/test_123/video.mp4`

### MinIO 文件访问
- **API端口**: `http://localhost:9000`
- **控制台**: `http://localhost:9001`
- **预签名URL**: 通过 MinIO API 生成临时访问链接

### Nginx 代理访问
- **本地文件**: `http://localhost/files/`
- **MinIO API**: `http://localhost/minio/`
- **MinIO 控制台**: `http://localhost/minio-console/`

## 🔒 安全配置

### MinIO 安全设置

```yaml
# 生产环境配置
storage:
  minio_secure: true  # 启用HTTPS
  minio_access_key: "your_access_key"
  minio_secret_key: "your_secret_key"
```

### 文件访问控制

```nginx
# Nginx 访问控制
location /files/ {
    # 添加访问控制
    allow 192.168.1.0/24;
    deny all;
    
    # 添加认证
    auth_basic "Restricted Access";
    auth_basic_user_file /etc/nginx/.htpasswd;
}
```

## 📈 性能优化

### 1. 并发下载控制
```python
# 配置并发数
storage:
  max_concurrent_downloads: 5
  download_timeout: 300
```

### 2. 分块下载
```python
# 配置分块大小
storage:
  chunk_size: 8192  # 8KB
```

### 3. 缓存策略
```python
# 启用文件缓存
storage:
  enable_cache: true
  cache_ttl: 3600  # 1小时
```

## 🛠️ 故障排除

### 常见问题

1. **MinIO 连接失败**
   ```bash
   # 检查 MinIO 服务状态
   docker-compose -f docker-compose.storage.yml ps
   
   # 查看 MinIO 日志
   docker-compose -f docker-compose.storage.yml logs minio
   ```

2. **数据库连接失败**
   ```bash
   # 检查 MySQL 服务状态
   docker-compose -f docker-compose.storage.yml ps mysql
   
   # 测试数据库连接
   mysql -h localhost -P 3306 -u root -p
   ```

3. **文件权限问题**
   ```bash
   # 检查目录权限
   ls -la /app/data/
   
   # 修复权限
   chmod -R 755 /app/data/
   ```

### 日志查看

```bash
# 查看应用日志
tail -f logs/mediacrawler.log

# 查看 Nginx 日志
docker-compose -f docker-compose.storage.yml logs nginx

# 查看 MinIO 日志
docker-compose -f docker-compose.storage.yml logs minio
```

## 📝 最佳实践

### 1. 文件命名规范
- 使用平台、日期、内容ID的层次结构
- 避免特殊字符和中文文件名
- 保持文件名的一致性

### 2. 存储策略选择
- 小文件（<10MB）使用本地存储
- 大文件（>10MB）使用 MinIO 存储
- 根据实际需求调整阈值

### 3. 数据备份
- 定期备份 MySQL 数据库
- 配置 MinIO 的版本控制
- 建立文件备份策略

### 4. 监控告警
- 监控存储空间使用率
- 设置文件数量告警
- 监控下载成功率

## 🔄 迁移和升级

### 从本地存储迁移到 MinIO

```python
async def migrate_to_minio():
    async with VideoStorageManager() as vsm:
        # 获取所有本地文件
        local_videos = await vsm.list_videos()
        
        for video in local_videos:
            if video["storage_type"] == "local":
                # 迁移到 MinIO
                await vsm.migrate_to_minio(video["id"])
```

### 配置升级

```bash
# 备份当前配置
cp config/config_local.yaml config/config_local.yaml.backup

# 更新配置
# 编辑相应环境的配置文件，如 config/config_local.yaml

# 重启服务
docker-compose -f docker-compose.storage.yml restart
```

## 📞 技术支持

如果您在使用过程中遇到问题，请：

1. 查看本文档的故障排除部分
2. 检查日志文件获取详细错误信息
3. 在项目 Issues 中提交问题
4. 联系技术支持团队

---

**注意**: 本存储系统仅供学习和研究使用，请遵守相关法律法规和平台使用条款。 